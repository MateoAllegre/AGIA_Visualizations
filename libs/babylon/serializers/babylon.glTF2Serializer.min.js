!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("babylonjs")):"function"==typeof define&&define.amd?define("babylonjs-serializers",["babylonjs"],t):"object"==typeof exports?exports["babylonjs-serializers"]=t(require("babylonjs")):e.SERIALIZERS=t(e.BABYLON)}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this,(e=>(()=>{"use strict";var t={597:t=>{t.exports=e}},r={};function n(e){var i=r[e];if(void 0!==i)return i.exports;var s=r[e]={exports:{}};return t[e](s,s.exports,n),s.exports}n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};n.d(i,{default:()=>Je});var s={};n.r(s),n.d(s,{__IGLTFExporterExtension:()=>f});var o={};n.r(o),n.d(o,{GLTFData:()=>p});var a={};n.r(a),n.d(a,{GLTF2Export:()=>ne});var u={};n.r(u),n.d(u,{EXT_materials_diffuse_roughness:()=>Ke,EXT_mesh_gpu_instancing:()=>se,EXT_texture_avif:()=>ze,EXT_texture_webp:()=>qe,KHR_draco_mesh_compression:()=>ae,KHR_lights_punctual:()=>he,KHR_materials_anisotropy:()=>de,KHR_materials_clearcoat:()=>me,KHR_materials_diffuse_transmission:()=>ye,KHR_materials_dispersion:()=>Te,KHR_materials_emissive_strength:()=>we,KHR_materials_ior:()=>Ee,KHR_materials_iridescence:()=>Re,KHR_materials_sheen:()=>Ce,KHR_materials_specular:()=>Ie,KHR_materials_transmission:()=>Fe,KHR_materials_unlit:()=>Ue,KHR_materials_volume:()=>Pe,KHR_texture_basisu:()=>He,KHR_texture_transform:()=>De});var c={};n.r(c),n.d(c,{EXT_materials_diffuse_roughness:()=>Ke,EXT_mesh_gpu_instancing:()=>se,EXT_texture_avif:()=>ze,EXT_texture_webp:()=>qe,GLTF2Export:()=>ne,GLTFData:()=>p,KHR_draco_mesh_compression:()=>ae,KHR_lights_punctual:()=>he,KHR_materials_anisotropy:()=>de,KHR_materials_clearcoat:()=>me,KHR_materials_diffuse_transmission:()=>ye,KHR_materials_dispersion:()=>Te,KHR_materials_emissive_strength:()=>we,KHR_materials_ior:()=>Ee,KHR_materials_iridescence:()=>Re,KHR_materials_sheen:()=>Ce,KHR_materials_specular:()=>Ie,KHR_materials_transmission:()=>Fe,KHR_materials_unlit:()=>Ue,KHR_materials_volume:()=>Pe,KHR_texture_basisu:()=>He,KHR_texture_transform:()=>De,_ConvertToGLTFPBRMetallicRoughness:()=>E,_SolveMetallic:()=>A});var l={};n.r(l),n.d(l,{EXT_materials_diffuse_roughness:()=>Ke,EXT_mesh_gpu_instancing:()=>se,EXT_texture_avif:()=>ze,EXT_texture_webp:()=>qe,GLTF2Export:()=>ne,GLTFData:()=>p,KHR_draco_mesh_compression:()=>ae,KHR_lights_punctual:()=>he,KHR_materials_anisotropy:()=>de,KHR_materials_clearcoat:()=>me,KHR_materials_diffuse_transmission:()=>ye,KHR_materials_dispersion:()=>Te,KHR_materials_emissive_strength:()=>we,KHR_materials_ior:()=>Ee,KHR_materials_iridescence:()=>Re,KHR_materials_sheen:()=>Ce,KHR_materials_specular:()=>Ie,KHR_materials_transmission:()=>Fe,KHR_materials_unlit:()=>Ue,KHR_materials_volume:()=>Pe,KHR_texture_basisu:()=>He,KHR_texture_transform:()=>De,_ConvertToGLTFPBRMetallicRoughness:()=>E,_SolveMetallic:()=>A,__IGLTFExporterExtension:()=>f});var f=0,h=n(597),p=function(){function e(){this.files={}}return Object.defineProperty(e.prototype,"glTFFiles",{get:function(){return this.files},enumerable:!1,configurable:!0}),e.prototype.downloadFiles=function(){for(var e in this.files){var t=this.files[e],r=new Blob([t],{type:(0,h.GetMimeType)(e)});h.Tools.Download(r,e)}},e}(),d=function(){return d=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},d.apply(this,arguments)};function _(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))}function m(e,t){var r,n,i,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=a(0),o.throw=a(1),o.return=a(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(a){return function(u){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(s=0)),s;)try{if(r=1,n&&(i=2&a[0]?n.return:a[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,a[1])).done)return i;switch(n=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((i=(i=s.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],n=0}finally{r=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}}function g(e,t,r){if(r||2===arguments.length)for(var n,i=0,s=t.length;i<s;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;var x=1e-6,y=new h.Color3(.04,.04,.04),v=1024,T=h.Color3.White(),b=h.Color3.Black();function w(e){return _(this,void 0,void 0,(function(){var t,r,n,i;return m(this,(function(s){switch(s.label){case 0:return(t=e.getInternalTexture())&&1===t.source?t.invertY?[2,null]:(r=t._buffer,i=e.mimeType,r?[3,2]:[4,h.Tools.LoadFileAsync(t.url)]):[2,null];case 1:return n=s.sent(),i=(0,h.GetMimeType)(t.url)||i,[3,10];case 2:return ArrayBuffer.isView(r)?(n=r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength),[3,10]):[3,3];case 3:return r instanceof ArrayBuffer?(n=r,[3,10]):[3,4];case 4:return r instanceof Blob?[4,r.arrayBuffer()]:[3,6];case 5:return n=s.sent(),i=r.type||i,[3,10];case 6:return"string"!=typeof r?[3,8]:[4,h.Tools.LoadFileAsync(r)];case 7:return n=s.sent(),i=(0,h.GetMimeType)(r)||i,[3,10];case 8:return"undefined"!=typeof HTMLImageElement&&r instanceof HTMLImageElement?[4,h.Tools.LoadFileAsync(r.src)]:[3,10];case 9:n=s.sent(),i=(0,h.GetMimeType)(r.src)||i,s.label=10;case 10:return n&&i?[2,{data:n,mimeType:i}]:[2,null]}}))}))}function A(e,t,r){if(t<y.r)return 0;var n=y.r,i=e*r/(1-y.r)+t-2*y.r,s=i*i-4*n*(y.r-t);return h.Scalar.Clamp((-i+Math.sqrt(s))/(2*n),0,1)}function E(e){var t=e.diffuseColor.toLinearSpace(e.getScene().getEngine().useExactSrgbConversions).scale(.5),r=e.alpha,n=h.Scalar.Clamp(e.specularPower,0,v),i=(0,h.SpecularPowerToRoughness)(n);return{baseColorFactor:[t.r,t.g,t.b,r],metallicFactor:0,roughnessFactor:i}}function M(e,t){t.needAlphaBlending()?e.alphaMode="BLEND":t.needAlphaTesting()&&(e.alphaMode="MASK",e.alphaCutoff=t.alphaCutOff)}function R(e,t,r){for(var n=new Uint8Array(e*t*4),i=0;i<n.length;i+=4)n[i]=n[i+1]=n[i+2]=n[i+3]=255;return h.RawTexture.CreateRGBATexture(n,e,t,r)}function V(e){if(e instanceof Uint8Array){for(var t=e.length,r=new Float32Array(e.length),n=0;n<t;++n)r[n]=e[n]/255;return r}if(e instanceof Float32Array)return e;throw new Error("Unsupported pixel format!")}var C=function(){function e(e){this._exporter=e,this._textureMap=new Map,this._internalTextureToImage={}}return e.prototype.getTextureInfo=function(e){var t;return e&&null!==(t=this._textureMap.get(e))&&void 0!==t?t:null},e.prototype.exportStandardMaterialAsync=function(e,t){return _(this,void 0,void 0,(function(){var r,n,i,s,o,a,u,c;return m(this,(function(l){switch(l.label){case 0:return r=E(e),n={name:e.name},null==e.backFaceCulling||e.backFaceCulling||(e.twoSidedLighting||h.Tools.Warn(e.name+": Back-face culling disabled and two-sided lighting disabled is not supported in glTF."),n.doubleSided=!0),t?(i=[],(s=e.diffuseTexture)&&i.push(this.exportTextureAsync(s).then((function(e){e&&(r.baseColorTexture=e)}))),(o=e.bumpTexture)&&i.push(this.exportTextureAsync(o).then((function(e){e&&(n.normalTexture=e,1!==o.level&&(n.normalTexture.scale=o.level))}))),(a=e.emissiveTexture)&&(n.emissiveFactor=[1,1,1],i.push(this.exportTextureAsync(a).then((function(e){e&&(n.emissiveTexture=e)})))),(u=e.ambientTexture)&&i.push(this.exportTextureAsync(u).then((function(e){if(e){var t={index:e.index};n.occlusionTexture=t}}))),i.length>0?(this._exporter._materialNeedsUVsSet.add(e),[4,Promise.all(i)]):[3,2]):[3,2];case 1:l.sent(),l.label=2;case 2:return(e.alpha<1||e.opacityTexture)&&(e.alphaMode===h.Constants.ALPHA_COMBINE?n.alphaMode="BLEND":h.Tools.Warn(e.name+": glTF 2.0 does not support alpha mode: "+e.alphaMode.toString())),e.emissiveColor&&!e.emissiveColor.equalsWithEpsilon(b,x)&&(n.emissiveFactor=e.emissiveColor.asArray()),n.pbrMetallicRoughness=r,M(n,e),[4,this._finishMaterialAsync(n,e)];case 3:return l.sent(),(c=this._exporter._materials).push(n),[2,c.length-1]}}))}))},e.prototype._finishMaterialAsync=function(e,t){return _(this,void 0,void 0,(function(){var r,n,i,s,o;return m(this,(function(a){switch(a.label){case 0:for(r=this._exporter._extensionsPostExportMaterialAdditionalTextures("exportMaterial",e,t),n=[],i=0,s=r;i<s.length;i++)o=s[i],n.push(this.exportTextureAsync(o));return[4,Promise.all(n)];case 1:return a.sent(),[4,this._exporter._extensionsPostExportMaterialAsync("exportMaterial",e,t)];case 2:return a.sent(),[2]}}))}))},e.prototype._getImageDataAsync=function(e,t,r,n){return _(this,void 0,void 0,(function(){return m(this,(function(i){switch(i.label){case 0:return[4,h.DumpTools.DumpDataAsync(t,r,e,n,void 0,!1,!0)];case 1:return[2,i.sent()]}}))}))},e.prototype._resizeTexturesToSameDimensions=function(e,t,r){var n,i,s=e?e.getSize():{width:0,height:0},o=t?t.getSize():{width:0,height:0};return s.width<o.width?(n=e&&e instanceof h.Texture?h.TextureTools.CreateResizedCopy(e,o.width,o.height,!0):R(o.width,o.height,r),i=t):s.width>o.width?(i=t&&t instanceof h.Texture?h.TextureTools.CreateResizedCopy(t,s.width,s.height,!0):R(s.width,s.height,r),n=e):(n=e,i=t),{texture1:n,texture2:i}},e.prototype._convertSpecularGlossinessTexturesToMetallicRoughnessAsync=function(e,t,r,n){return _(this,void 0,void 0,(function(){var i,s,o,a,u,c,l,f,p,d,_,g,y,v,w,A,E,M,R,C,S,I,B,F,N,U,O,P,L,K,k;return m(this,(function(m){switch(m.label){case 0:return i=new Array,e||t?[3,2]:[4,Promise.reject("diffuse and specular glossiness textures are not defined!")];case 1:case 6:case 9:case 11:case 13:return[2,m.sent()];case 2:return(s=e?e.getScene():t?t.getScene():null)?(o=this._resizeTexturesToSameDimensions(e,t,s),a=null===(k=o.texture1)||void 0===k?void 0:k.getSize(),u=void 0,c=void 0,l=a.width,f=a.height,[4,o.texture1.readPixels()]):[3,12];case 3:return p=m.sent(),[4,o.texture2.readPixels()];case 4:return d=m.sent(),p?(u=V(p),[3,7]):[3,5];case 5:return[4,Promise.reject("Failed to retrieve pixels from diffuse texture!")];case 7:return d?(c=V(d),[3,10]):[3,8];case 8:return[4,Promise.reject("Failed to retrieve pixels from specular glossiness texture!")];case 10:for(_=c.byteLength,g=new Uint8Array(_),y=new Uint8Array(_),v=b,w=0,A=0,U=0;U<f;++U)for(O=0;O<l;++O)E=4*(l*U+O),M=new h.Color3(u[E],u[E+1],u[E+2]).toLinearSpace(s.getEngine().useExactSrgbConversions).multiply(r.diffuseColor),R=new h.Color3(c[E],c[E+1],c[E+2]).toLinearSpace(s.getEngine().useExactSrgbConversions).multiply(r.specularColor),C=c[E+3]*r.glossiness,S={diffuseColor:M,specularColor:R,glossiness:C},I=this._convertSpecularGlossinessToMetallicRoughness(S),v.r=Math.max(v.r,I.baseColor.r),v.g=Math.max(v.g,I.baseColor.g),v.b=Math.max(v.b,I.baseColor.b),w=Math.max(w,I.metallic),A=Math.max(A,I.roughness),y[E]=255*I.baseColor.r,y[E+1]=255*I.baseColor.g,y[E+2]=255*I.baseColor.b,y[E+3]=o.texture1.hasAlpha?255*u[E+3]:255,g[E]=0,g[E+1]=255*I.roughness,g[E+2]=255*I.metallic,g[E+3]=255;for(B={baseColor:v,metallic:w,roughness:A},F=!1,N=!1,U=0;U<f;++U)for(O=0;O<l;++O)y[P=4*(l*U+O)]/=B.baseColor.r>x?B.baseColor.r:1,y[P+1]/=B.baseColor.g>x?B.baseColor.g:1,y[P+2]/=B.baseColor.b>x?B.baseColor.b:1,L=h.Color3.FromInts(y[P],y[P+1],y[P+2]),K=L.toGammaSpace(s.getEngine().useExactSrgbConversions),y[P]=255*K.r,y[P+1]=255*K.g,y[P+2]=255*K.b,K.equalsWithEpsilon(T,x)||(N=!0),g[P+1]/=B.roughness>x?B.roughness:1,g[P+2]/=B.metallic>x?B.metallic:1,h.Color3.FromInts(255,g[P+1],g[P+2]).equalsWithEpsilon(T,x)||(F=!0);return F&&i.push(this._getImageDataAsync(g,l,f,n).then((function(e){B.metallicRoughnessTextureData=e}))),N&&i.push(this._getImageDataAsync(y,l,f,n).then((function(e){B.baseColorTextureData=e}))),[4,Promise.all(i).then((function(){return B}))];case 12:return[4,Promise.reject("_ConvertSpecularGlossinessTexturesToMetallicRoughness: Scene from textures is missing!")]}}))}))},e.prototype._convertSpecularGlossinessToMetallicRoughness=function(e){var t=this._getPerceivedBrightness(e.diffuseColor),r=this._getPerceivedBrightness(e.specularColor),n=1-this._getMaxComponent(e.specularColor),i=A(t,r,n),s=e.diffuseColor.scale(n/(1-y.r)/Math.max(1-i)),o=e.specularColor.subtract(y.scale(1-i)).scale(1/Math.max(i)),a=h.Color3.Lerp(s,o,i*i);return{baseColor:a=a.clampToRef(0,1,a),metallic:i,roughness:1-e.glossiness}},e.prototype._getPerceivedBrightness=function(e){return e?Math.sqrt(.299*e.r*e.r+.587*e.g*e.g+.114*e.b*e.b):0},e.prototype._getMaxComponent=function(e){return e?Math.max(e.r,Math.max(e.g,e.b)):0},e.prototype._convertMetalRoughFactorsToMetallicRoughnessAsync=function(e,t,r){return _(this,void 0,void 0,(function(){var n,i,s,o;return m(this,(function(a){switch(a.label){case 0:return n=[],i={baseColor:e._albedoColor,metallic:e._metallic,roughness:e._roughness},r&&((s=e._albedoTexture)&&n.push(this.exportTextureAsync(s).then((function(e){e&&(t.baseColorTexture=e)}))),(o=e._metallicTexture)&&n.push(this.exportTextureAsync(o).then((function(e){e&&(t.metallicRoughnessTexture=e)})))),n.length>0?(this._exporter._materialNeedsUVsSet.add(e),[4,Promise.all(n)]):[3,2];case 1:a.sent(),a.label=2;case 2:return[2,i]}}))}))},e.prototype._getTextureSampler=function(e){var t={};if(!(e&&e instanceof h.Texture))return t;var r=this._getGLTFTextureWrapMode(e.wrapU);10497!==r&&(t.wrapS=r);var n=this._getGLTFTextureWrapMode(e.wrapV);switch(10497!==n&&(t.wrapT=n),e.samplingMode){case h.Texture.LINEAR_LINEAR:t.magFilter=9729,t.minFilter=9729;break;case h.Texture.LINEAR_NEAREST:t.magFilter=9729,t.minFilter=9728;break;case h.Texture.NEAREST_LINEAR:t.magFilter=9728,t.minFilter=9729;break;case h.Texture.NEAREST_LINEAR_MIPLINEAR:t.magFilter=9728,t.minFilter=9987;break;case h.Texture.NEAREST_NEAREST:t.magFilter=9728,t.minFilter=9728;break;case h.Texture.NEAREST_LINEAR_MIPNEAREST:t.magFilter=9728,t.minFilter=9985;break;case h.Texture.LINEAR_NEAREST_MIPNEAREST:t.magFilter=9729,t.minFilter=9984;break;case h.Texture.LINEAR_NEAREST_MIPLINEAR:t.magFilter=9729,t.minFilter=9986;break;case h.Texture.NEAREST_NEAREST_MIPLINEAR:t.magFilter=9728,t.minFilter=9986;break;case h.Texture.LINEAR_LINEAR_MIPLINEAR:t.magFilter=9729,t.minFilter=9987;break;case h.Texture.LINEAR_LINEAR_MIPNEAREST:t.magFilter=9729,t.minFilter=9985;break;case h.Texture.NEAREST_NEAREST_MIPNEAREST:t.magFilter=9728,t.minFilter=9984}return t},e.prototype._getGLTFTextureWrapMode=function(e){switch(e){case h.Texture.WRAP_ADDRESSMODE:return 10497;case h.Texture.CLAMP_ADDRESSMODE:return 33071;case h.Texture.MIRROR_ADDRESSMODE:return 33648;default:return h.Tools.Error("Unsupported Texture Wrap Mode ".concat(e,"!")),10497}},e.prototype._convertSpecGlossFactorsToMetallicRoughnessAsync=function(e,t,r){return _(this,void 0,void 0,(function(){var n,i,s,o,a,u,c,l,f;return m(this,(function(h){switch(h.label){case 0:return n="image/png",i={diffuseColor:e._albedoColor,specularColor:e._reflectivityColor,glossiness:e._microSurface},s=e._albedoTexture,o=e._reflectivityTexture,a=e._useMicroSurfaceFromReflectivityMapAlpha,!o||a?[3,2]:[4,Promise.reject("_ConvertPBRMaterial: Glossiness values not included in the reflectivity texture are currently not supported")];case 1:return[2,h.sent()];case 2:return(s||o)&&r?(this._exporter._materialNeedsUVsSet.add(e),u=this._exportTextureSampler(s||o),[4,this._convertSpecularGlossinessTexturesToMetallicRoughnessAsync(s,o,i,n)]):[3,4];case 3:return c=h.sent(),l=this._exporter._textures,c.baseColorTextureData&&(f=this._exportImage("baseColor".concat(l.length),n,c.baseColorTextureData),t.baseColorTexture=this._exportTextureInfo(f,u,null==s?void 0:s.coordinatesIndex)),c.metallicRoughnessTextureData&&(f=this._exportImage("metallicRoughness".concat(l.length),n,c.metallicRoughnessTextureData),t.metallicRoughnessTexture=this._exportTextureInfo(f,u,null==o?void 0:o.coordinatesIndex)),[2,c];case 4:return[2,this._convertSpecularGlossinessToMetallicRoughness(i)]}}))}))},e.prototype.exportPBRMaterialAsync=function(e,t){return _(this,void 0,void 0,(function(){var r,n,i,s,o,a,u,c;return m(this,(function(l){switch(l.label){case 0:return r={},n={name:e.name},(i=e.isMetallicWorkflow())&&(s=e._albedoColor,o=e.alpha,s&&(r.baseColorFactor=[s.r,s.g,s.b,o])),i?[4,this._convertMetalRoughFactorsToMetallicRoughnessAsync(e,r,t)]:[3,2];case 1:return u=l.sent(),[3,4];case 2:return[4,this._convertSpecGlossFactorsToMetallicRoughnessAsync(e,r,t)];case 3:u=l.sent(),l.label=4;case 4:return a=u,[4,this._setMetallicRoughnessPbrMaterialAsync(a,e,n,r,t)];case 5:return l.sent(),[4,this._finishMaterialAsync(n,e)];case 6:return l.sent(),(c=this._exporter._materials).push(n),[2,c.length-1]}}))}))},e.prototype._setMetallicRoughnessPbrMaterialAsync=function(e,t,r,n,i){return _(this,void 0,void 0,(function(){var s,o,a,u,c;return m(this,(function(l){switch(l.label){case 0:return M(r,t),e.baseColor.equalsWithEpsilon(T,x)&&h.Scalar.WithinEpsilon(t.alpha,1,x)||(n.baseColorFactor=[e.baseColor.r,e.baseColor.g,e.baseColor.b,t.alpha]),null!=e.metallic&&1!==e.metallic&&(n.metallicFactor=e.metallic),null!=e.roughness&&1!==e.roughness&&(n.roughnessFactor=e.roughness),null==t.backFaceCulling||t.backFaceCulling||(t._twoSidedLighting||h.Tools.Warn(t.name+": Back-face culling disabled and two-sided lighting disabled is not supported in glTF."),r.doubleSided=!0),i?(s=[],(o=t._bumpTexture)&&s.push(this.exportTextureAsync(o).then((function(e){e&&(r.normalTexture=e,1!==o.level&&(r.normalTexture.scale=o.level))}))),(a=t._ambientTexture)&&s.push(this.exportTextureAsync(a).then((function(e){if(e){var n={index:e.index,texCoord:e.texCoord,extensions:e.extensions};r.occlusionTexture=n;var i=t._ambientTextureStrength;i&&(n.strength=i)}}))),(u=t._emissiveTexture)&&s.push(this.exportTextureAsync(u).then((function(e){e&&(r.emissiveTexture=e)}))),s.length>0?(this._exporter._materialNeedsUVsSet.add(t),[4,Promise.all(s)]):[3,2]):[3,2];case 1:l.sent(),l.label=2;case 2:return(c=t._emissiveColor).equalsWithEpsilon(b,x)||(r.emissiveFactor=c.asArray()),r.pbrMetallicRoughness=n,[2]}}))}))},e.prototype.exportTextureAsync=function(e){return _(this,void 0,void 0,(function(){var t,r,n;return m(this,(function(i){switch(i.label){case 0:return(t=this._textureMap.get(e))?[2,t]:(r=this._exportTextureSampler(e),[4,this._exportTextureImageAsync(e)]);case 1:return n=i.sent(),t=this._exportTextureInfo(n,r,e.coordinatesIndex),this._textureMap.set(e,t),this._exporter._extensionsPostExportTextures("exporter",t,e),[2,t]}}))}))},e.prototype._exportTextureImageAsync=function(e){return _(this,void 0,void 0,(function(){var t,r,n,i,s,o=this;return m(this,(function(a){switch(a.label){case 0:return t=null!==(s=e.mimeType)&&void 0!==s?s:"none",r=this._internalTextureToImage,n=e.getInternalTexture().uniqueId,r[n]=r[n]||{},void 0===(i=r[n][t])&&(i=_(o,void 0,void 0,(function(){var r,n,i,s,o;return m(this,(function(a){switch(a.label){case 0:return[4,w(e)];case 1:if((r=a.sent())&&("none"===t||r.mimeType===t))return[2,this._exportImage(e.name,r.mimeType,r.data)];if(n="image/png","none"!==t)switch(t){case"image/jpeg":case"image/png":case"image/webp":n=t;break;default:h.Tools.Warn("Unsupported media type: ".concat(t,". Exporting texture as PNG."))}return i=e.getSize(),[4,(0,h.GetTextureDataAsync)(e)];case 2:return s=a.sent(),[4,this._getImageDataAsync(s,i.width,i.height,n)];case 3:return o=a.sent(),[2,this._exportImage(e.name,n,o)]}}))})),r[n][t]=i),[4,i];case 1:return[2,a.sent()]}}))}))},e.prototype._exportImage=function(e,t,r){var n,i=this._exporter._images;if(this._exporter._shouldUseGlb){n={name:e,mimeType:t,bufferView:void 0};var s=this._exporter._bufferManager.createBufferView(new Uint8Array(r));this._exporter._bufferManager.setBufferView(n,s)}else{var o=e.replace(/\.\/|\/|\.\\|\\/g,"_"),a=function(e){switch(e){case"image/jpeg":return".jpg";case"image/png":return".png";case"image/webp":return".webp";case"image/avif":return".avif";case"image/ktx2":return".ktx2"}}(t),u=o+a;i.some((function(e){return e.uri===u}))&&(u="".concat(o,"_").concat(h.Tools.RandomId()).concat(a)),n={name:e,uri:u},this._exporter._imageData[u]={data:r,mimeType:t}}return i.push(n),i.length-1},e.prototype._exportTextureInfo=function(e,t,r){var n=this._exporter._textures,i=n.findIndex((function(r){return r.sampler==t&&r.source===e}));-1===i&&(i=n.length,n.push({source:e,sampler:t}));var s={index:i};return r&&(s.texCoord=r),s},e.prototype._exportTextureSampler=function(e){var t=this._getTextureSampler(e),r=this._exporter._samplers,n=r.findIndex((function(e){return e.minFilter===t.minFilter&&e.magFilter===t.magFilter&&e.wrapS===t.wrapS&&e.wrapT===t.wrapT}));return-1!==n?n:(r.push(t),r.length-1)},e}(),S=h.Matrix.Compose(new h.Vector3(-1,1,1),h.Quaternion.Identity(),h.Vector3.Zero());function I(e,t){if(!(e instanceof h.TransformNode))return!1;if(t){if(!e.getWorldMatrix().equalsWithEpsilon(h.Matrix.IdentityReadOnly,h.Epsilon))return!1}else if(!e.getWorldMatrix().multiplyToRef(S,h.TmpVectors.Matrix[0]).equalsWithEpsilon(h.Matrix.IdentityReadOnly,h.Epsilon))return!1;return!(e instanceof h.AbstractMesh&&e.geometry)}var B=h.Vector3.Zero(),F=h.Quaternion.Identity(),N=h.Vector3.One(),U=new h.Vector3(-1,1,1);function O(e,t){var r=e.byteOffset,n=e.byteStride,i=e.type,s=e.normalized,o=e.getSize(),a=t.reduce((function(e,t){return t.getTotalVertices()>e?t.getTotalVertices():e}),-Number.MAX_VALUE);return{byteOffset:r,byteStride:n,componentCount:o,type:i,count:a*o,normalized:s,totalVertices:a,kind:e.getKind()}}function P(e){switch(e){case"MAT2":case"VEC4":return 4;case"MAT3":return 9;case"MAT4":return 16;case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3}}function L(e){switch(e){case h.VertexBuffer.PositionKind:case h.VertexBuffer.NormalKind:case h.VertexBuffer.TangentKind:case h.VertexBuffer.ColorKind:case h.VertexBuffer.MatricesIndicesKind:case h.VertexBuffer.MatricesIndicesExtraKind:case h.VertexBuffer.MatricesWeightsKind:case h.VertexBuffer.MatricesWeightsExtraKind:case h.VertexBuffer.UVKind:case h.VertexBuffer.UV2Kind:case h.VertexBuffer.UV3Kind:case h.VertexBuffer.UV4Kind:case h.VertexBuffer.UV5Kind:case h.VertexBuffer.UV6Kind:return!0}return!1}function K(e){switch(e){case h.Material.TriangleFillMode:return 4;case h.Material.TriangleStripDrawMode:return 5;case h.Material.TriangleFanDrawMode:return 6;case h.Material.PointListDrawMode:case h.Material.PointFillMode:return 0;case h.Material.LineLoopDrawMode:return 2;case h.Material.LineListDrawMode:return 1;case h.Material.LineStripDrawMode:return 3}throw new Error("Unknown fill mode: ".concat(e))}function k(e){var t=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);t>0&&(e.x/=t,e.y/=t,e.z/=t)}function D(e){return e.x*=-1,e}function G(e){if(e.x*e.x+e.y*e.y>.5){var t=Math.abs(e.x),r=Math.abs(e.y);if(t>r){var n=Math.sign(e.x);e.x=t,e.y*=-n,e.z*=-n,e.w*=n}else n=Math.sign(e.y),e.x*=-n,e.y=r,e.z*=n,e.w*=-n}else{var i=Math.abs(e.z),s=Math.abs(e.w);i>s?(n=Math.sign(e.z),e.x*=-n,e.y*=n,e.z=i,e.w*=-n):(n=Math.sign(e.w),e.x*=n,e.y*=-n,e.z*=-n,e.w=s)}return e}function H(e){e.copyFromFloats(-e.z,e.w,e.x,-e.y)}function W(e,t){var r=h.Vector3.FromArrayToRef(t.translation||[0,0,0],0,h.TmpVectors.Vector3[0]),n=h.Quaternion.FromArrayToRef(t.rotation||[0,0,0,1],0,h.TmpVectors.Quaternion[0]),i=h.Matrix.ComposeToRef(N,n,r,h.TmpVectors.Matrix[0]),s=h.Vector3.FromArrayToRef(e.translation||[0,0,0],0,h.TmpVectors.Vector3[2]),o=h.Quaternion.FromArrayToRef(e.rotation||[0,0,0,1],0,h.TmpVectors.Quaternion[1]),a=h.Matrix.ComposeToRef(N,o,s,h.TmpVectors.Matrix[1]);i.multiplyToRef(a,a),a.decompose(void 0,n,r),r.equalsWithEpsilon(B,h.Epsilon)?delete t.translation:t.translation=r.asArray(),n.equalsWithEpsilon(F,h.Epsilon)?delete t.rotation:t.rotation=n.asArray(),t.scale&&delete t.scale}function q(e,t){if(!(t instanceof h.TransformNode))return!1;if(1!==t.getChildren().length||0!==e.getChildren().length||e.parent!==t)return!1;var r=e.getScene(),n=e instanceof h.TargetCamera&&!r.useRightHandedSystem?U:N;return!!t.scaling.equalsWithEpsilon(n,h.Epsilon)||(h.Logger.Warn("Cannot collapse node ".concat(e.name," into parent node ").concat(t.name," with modified scaling.")),!1)}function j(e,t){for(var r=0,n=Object.entries(e);r<n.length;r++){var i=n[r],s=i[0],o=i[1],a=t[s];(Array.isArray(o)&&Array.isArray(a)&&z(o,a)||o===a)&&delete e[s]}return e}function z(e,t){return e.length===t.length&&e.every((function(e,r){return e===t[r]}))}var Q=new Map([[Int8Array,function(e,t,r){return e.setInt8(t,r)}],[Uint8Array,function(e,t,r){return e.setUint8(t,r)}],[Uint8ClampedArray,function(e,t,r){return e.setUint8(t,r)}],[Int16Array,function(e,t,r){return e.setInt16(t,r,!0)}],[Uint16Array,function(e,t,r){return e.setUint16(t,r,!0)}],[Int32Array,function(e,t,r){return e.setInt32(t,r,!0)}],[Uint32Array,function(e,t,r){return e.setUint32(t,r,!0)}],[Float32Array,function(e,t,r){return e.setFloat32(t,r,!0)}],[Float64Array,function(e,t,r){return e.setFloat64(t,r,!0)}]]),X=function(){function e(e){this._data=new Uint8Array(e),this._dataView=new DataView(this._data.buffer),this._byteOffset=0}return e.prototype.writeTypedArray=function(e){this._checkGrowBuffer(e.byteLength);for(var t=Q.get(e.constructor),r=0;r<e.length;r++)t(this._dataView,this._byteOffset,e[r]),this._byteOffset+=e.BYTES_PER_ELEMENT},Object.defineProperty(e.prototype,"byteOffset",{get:function(){return this._byteOffset},enumerable:!1,configurable:!0}),e.prototype.getOutputData=function(){return new Uint8Array(this._data.buffer,0,this._byteOffset)},e.prototype.writeUInt8=function(e){this._checkGrowBuffer(1),this._dataView.setUint8(this._byteOffset,e),this._byteOffset++},e.prototype.writeInt8=function(e){this._checkGrowBuffer(1),this._dataView.setInt8(this._byteOffset,e),this._byteOffset++},e.prototype.writeInt16=function(e){this._checkGrowBuffer(2),this._dataView.setInt16(this._byteOffset,e,!0),this._byteOffset+=2},e.prototype.writeUInt16=function(e){this._checkGrowBuffer(2),this._dataView.setUint16(this._byteOffset,e,!0),this._byteOffset+=2},e.prototype.writeInt32=function(e){this._checkGrowBuffer(4),this._dataView.setInt32(this._byteOffset,e,!0),this._byteOffset+=4},e.prototype.writeUInt32=function(e){this._checkGrowBuffer(4),this._dataView.setUint32(this._byteOffset,e,!0),this._byteOffset+=4},e.prototype.writeFloat32=function(e){this._checkGrowBuffer(4),this._dataView.setFloat32(this._byteOffset,e,!0),this._byteOffset+=4},e.prototype.writeFloat64=function(e){this._checkGrowBuffer(8),this._dataView.setFloat64(this._byteOffset,e,!0),this._byteOffset+=8},e.prototype._checkGrowBuffer=function(e){var t=this.byteOffset+e;if(t>this._data.byteLength){var r=new Uint8Array(2*t);r.set(this._data),this._data=r,this._dataView=new DataView(this._data.buffer)}},e}();function Y(e){return e%4==0?4:e%2==0?2:1}var Z,J=function(){function e(){this._bufferViewToData=new Map,this._bufferViewToProperties=new Map,this._accessorToBufferView=new Map}return e.prototype.generateBinary=function(e){var t=0;this._bufferViewToData.forEach((function(e){t+=e.byteLength}));for(var r=new X(t),n=0,i=Array.from(this._bufferViewToData.keys()).sort((function(e,t){return Y(t.byteLength)-Y(e.byteLength)}));n<i.length;n++){var s=i[n];s.byteOffset=r.byteOffset,e.push(s);for(var o=e.length-1,a=0,u=this.getPropertiesWithBufferView(s);a<u.length;a++)u[a].bufferView=o;r.writeTypedArray(this._bufferViewToData.get(s)),this._bufferViewToData.delete(s)}return r.getOutputData()},e.prototype.createBufferView=function(e,t){var r={buffer:0,byteOffset:void 0,byteLength:e.byteLength,byteStride:t};return this._bufferViewToData.set(r,e),r},e.prototype.createAccessor=function(e,t,r,n,i,s,o){this._verifyBufferView(e);var a={bufferView:void 0,componentType:r,count:n,type:t,min:null==s?void 0:s.min,max:null==s?void 0:s.max,normalized:o,byteOffset:i};return this.setBufferView(a,e),this._accessorToBufferView.set(a,e),a},e.prototype.setBufferView=function(e,t){this._verifyBufferView(t),this.getPropertiesWithBufferView(t).push(e)},e.prototype.removeBufferView=function(e){for(var t=this,r=0,n=this.getPropertiesWithBufferView(e);r<n.length;r++){var i=n[r];void 0!==i.bufferView&&delete i.bufferView}this._bufferViewToData.delete(e),this._bufferViewToProperties.delete(e),this._accessorToBufferView.forEach((function(r,n){r===e&&(void 0!==n.byteOffset&&delete n.byteOffset,t._accessorToBufferView.delete(n))}))},e.prototype.getBufferView=function(e){var t=this._accessorToBufferView.get(e);return this._verifyBufferView(t),t},e.prototype.getPropertiesWithBufferView=function(e){var t;return this._verifyBufferView(e),this._bufferViewToProperties.set(e,null!==(t=this._bufferViewToProperties.get(e))&&void 0!==t?t:[]),this._bufferViewToProperties.get(e)},e.prototype.getData=function(e){return this._verifyBufferView(e),this._bufferViewToData.get(e)},e.prototype._verifyBufferView=function(e){if(void 0===e||!this._bufferViewToData.has(e))throw new Error("BufferView ".concat(e," not found in BufferManager."))},e}();!function(e){e[e.INTANGENT=0]="INTANGENT",e[e.OUTTANGENT=1]="OUTTANGENT"}(Z||(Z={}));var $=function(){function e(){}return e._IsTransformable=function(e){return e&&(e instanceof h.TransformNode||e instanceof h.Camera||e instanceof h.Light)},e._CreateNodeAnimation=function(t,r,n,i,s){if(this._IsTransformable(t)){var o=[],a=[],u=r.getKeys(),c=e._CalculateMinMaxKeyFrames(u),l=e._DeduceInterpolation(u,n,i),f=l.interpolationType,p=l.shouldBakeAnimation;if(p?e._CreateBakedAnimation(t,r,n,c.min,c.max,r.framePerSecond,s,o,a,c,i):"LINEAR"===f||"STEP"===f?e._CreateLinearOrStepAnimation(t,r,n,o,a,i):"CUBICSPLINE"===f?e._CreateCubicSplineAnimation(t,r,n,o,a,i):e._CreateBakedAnimation(t,r,n,c.min,c.max,r.framePerSecond,s,o,a,c,i),o.length&&a.length)return{inputs:o,outputs:a,samplerInterpolation:f,inputsMin:p?c.min:h.Tools.FloatRound(c.min/r.framePerSecond),inputsMax:p?c.max:h.Tools.FloatRound(c.max/r.framePerSecond)}}return null},e._DeduceAnimationInfo=function(e){var t=null,r="VEC3",n=!1,i=e.targetProperty.split(".");switch(i[0]){case"scaling":t="scale";break;case"position":t="translation";break;case"rotation":r="VEC4",t="rotation";break;case"rotationQuaternion":r="VEC4",n=!0,t="rotation";break;case"influence":r="SCALAR",t="weights";break;default:h.Tools.Error("Unsupported animatable property ".concat(i[0]))}return t?{animationChannelTargetPath:t,dataAccessorType:r,useQuaternion:n}:(h.Tools.Error("animation channel target path and data accessor type could be deduced"),null)},e._CreateNodeAnimationFromNodeAnimations=function(t,r,n,i,s,o,a,u,c,l,f){var h;if(e._IsTransformable(t)&&t.animations)for(var p=0,d=t.animations;p<d.length;p++){var _=d[p];if(!f||f(_)){var m=e._DeduceAnimationInfo(_);m&&(h={name:_.name,samplers:[],channels:[]},e._AddAnimation("".concat(_.name),_.hasRunningRuntimeAnimations?r:h,t,_,m.dataAccessorType,m.animationChannelTargetPath,i,o,a,u,m.useQuaternion,c,l),h.samplers.length&&h.channels.length&&n.push(h))}}},e._CreateMorphTargetAnimationFromMorphTargetAnimations=function(t,r,n,i,s,o,a,u,c,l,f){var p;if(t instanceof h.Mesh){var d=t.morphTargetManager;if(d)for(var _=0;_<d.numTargets;++_)for(var m=0,g=d.getTarget(_).animations;m<g.length;m++){var x=g[m];if(!f||f(x)){for(var y=new h.Animation("".concat(x.name),"influence",x.framePerSecond,x.dataType,x.loopMode,x.enableBlending),v=[],T=x.getKeys(),b=0;b<T.length;++b)for(var w=T[b],A=0;A<d.numTargets;++A)A==_?v.push(w):v.push({frame:w.frame,value:0});y.setKeys(v);var E=e._DeduceAnimationInfo(y);E&&(p={name:y.name,samplers:[],channels:[]},e._AddAnimation(x.name,x.hasRunningRuntimeAnimations?r:p,t,y,E.dataAccessorType,E.animationChannelTargetPath,i,o,a,u,E.useQuaternion,c,l,d.numTargets),p.samplers.length&&p.channels.length&&n.push(p))}}}},e._CreateNodeAndMorphAnimationFromAnimationGroups=function(t,r,n,i,s,o,a,u,c){var l,f;if(t.animationGroups)for(var p=t.animationGroups,d=function(p){var d=new Map,m=new Map,g=new Set,x=p.to-p.from;f={name:p.name,channels:[],samplers:[]};for(var y=function(r){var x=p.targetedAnimations[r],y=x.target,v=x.animation;if(c&&!c(v))return"continue";var T=u.has(y);if(_._IsTransformable(y)||1===y.length&&_._IsTransformable(y[0])){if(w=e._DeduceAnimationInfo(x.animation)){var b=_._IsTransformable(y)?y:_._IsTransformable(y[0])?y[0]:null;b&&e._AddAnimation("".concat(v.name),f,b,v,w.dataAccessorType,w.animationChannelTargetPath,n,i,s,o,w.useQuaternion,a,T)}}else if(y instanceof h.MorphTarget||1===y.length&&y[0]instanceof h.MorphTarget){var w;if(w=e._DeduceAnimationInfo(x.animation)){var A=y instanceof h.MorphTarget?y:y[0];if(A){var E=t.morphTargetManagers.find((function(e){for(var t=0;t<e.numTargets;++t)if(e.getTarget(t)===A)return!0;return!1}));if(E){var M=t.meshes.find((function(e){return e.morphTargetManager===E}));M&&(d.has(M)||d.set(M,new Map),null===(l=d.get(M))||void 0===l||l.set(A,v),g.add(M),m.set(M,v))}}}}},v=0;v<p.targetedAnimations.length;++v)y(v);g.forEach((function(t){for(var r=t.morphTargetManager,u=null,c=[],l=m.get(t).getKeys(),_=l.length,g=0;g<_;++g)for(var y=0;y<r.numTargets;++y){var v=r.getTarget(y),T=d.get(t);if(T){var b=T.get(v);b?(u||(u=new h.Animation("".concat(p.name,"_").concat(t.name,"_MorphWeightAnimation"),"influence",b.framePerSecond,h.Animation.ANIMATIONTYPE_FLOAT,b.loopMode,b.enableBlending)),c.push(b.getKeys()[g])):c.push({frame:p.from+x/_*g,value:v.influence,inTangent:l[0].inTangent?0:void 0,outTangent:l[0].outTangent?0:void 0})}}u.setKeys(c);var w=e._DeduceAnimationInfo(u);w&&e._AddAnimation("".concat(p.name,"_").concat(t.name,"_MorphWeightAnimation"),f,t,u,w.dataAccessorType,w.animationChannelTargetPath,n,i,s,o,w.useQuaternion,a,!1,null==r?void 0:r.numTargets)})),f.channels.length&&f.samplers.length&&r.push(f)},_=this,m=0,g=p;m<g.length;m++)d(g[m])},e._AddAnimation=function(t,r,n,i,s,o,a,u,c,l,f,p,d,_){var m,g,x,y,v,T,b=e._CreateNodeAnimation(n,i,o,f,p);if(b){if(_){for(var w=0,A=0,E=[];b.inputs.length>0;)A=b.inputs.shift(),w%_==0&&E.push(A),w++;b.inputs=E}var M=a.get(n),R=new Float32Array(b.inputs);m=u.createBufferView(R),g=u.createAccessor(m,"SCALAR",5126,b.inputs.length,void 0,{min:[b.inputsMin],max:[b.inputsMax]}),l.push(g),x=l.length-1;var V=new h.Quaternion,C=new h.Vector3,S=new h.Vector3,I=n instanceof h.Camera,B=P(s),F=new Float32Array(b.outputs.length*B);b.outputs.forEach((function(e,t){var r=e;switch(o){case"translation":d&&(h.Vector3.FromArrayToRef(e,0,S),D(S),S.toArray(r));break;case"rotation":4===e.length?h.Quaternion.FromArrayToRef(e,0,V):(r=new Array(4),h.Vector3.FromArrayToRef(e,0,C),h.Quaternion.FromEulerVectorToRef(C,V)),d&&(G(V),I&&H(V)),V.toArray(r)}F.set(r,t*B)})),m=u.createBufferView(F),g=u.createAccessor(m,s,5126,b.outputs.length),l.push(g),y=l.length-1,v={interpolation:b.samplerInterpolation,input:x,output:y},r.samplers.push(v),T={sampler:r.samplers.length-1,target:{node:M,path:o}},r.channels.push(T)}},e._CreateBakedAnimation=function(t,r,n,i,s,o,a,u,c,l,f){var p,d,_=h.Quaternion.Identity(),m=null,g=null,x=null,y=null,v=null,T=null;l.min=h.Tools.FloatRound(i/o);for(var b=r.getKeys(),w=0,A=b.length;w<A;++w){if(T=null,x=b[w],w+1<A)if(y=b[w+1],x.value.equals&&x.value.equals(y.value)||x.value===y.value){if(0!==w)continue;T=x.frame}else T=y.frame;else{if(v=b[w-1],x.value.equals&&x.value.equals(v.value)||x.value===v.value)continue;T=s}if(T)for(var E=x.frame;E<=T;E+=a)if((d=h.Tools.FloatRound(E/o))!==m){m=d,g=d;var M={key:0,repeatCount:0,loopMode:r.loopMode};p=r._interpolate(E,M),e._SetInterpolatedValue(t,p,d,r,n,_,u,c,f)}}g&&(l.max=g)},e._ConvertFactorToVector3OrQuaternion=function(t,r,n,i,s){var o=e._GetBasePositionRotationOrScale(r,i,s),a=n.targetProperty.split("."),u=a?a[1]:"",c=s?h.Quaternion.FromArray(o).normalize():h.Vector3.FromArray(o);switch(u){case"x":case"y":case"z":c[u]=t;break;case"w":c.w=t;break;default:h.Tools.Error('glTFAnimation: Unsupported component name "'.concat(u,'"!'))}return c},e._SetInterpolatedValue=function(e,t,r,n,i,s,o,a,u){var c;o.push(r),"weights"!==i?(n.dataType===h.Animation.ANIMATIONTYPE_FLOAT&&(t=this._ConvertFactorToVector3OrQuaternion(t,e,n,i,u)),"rotation"===i?(u?s=t:(c=t,h.Quaternion.RotationYawPitchRollToRef(c.y,c.x,c.z,s)),a.push(s.asArray())):(c=t,a.push(c.asArray()))):a.push([t])},e._CreateLinearOrStepAnimation=function(t,r,n,i,s,o){for(var a=0,u=r.getKeys();a<u.length;a++){var c=u[a];i.push(c.frame/r.framePerSecond),e._AddKeyframeValue(c,r,s,n,t,o)}},e._CreateCubicSplineAnimation=function(t,r,n,i,s,o){r.getKeys().forEach((function(a){i.push(a.frame/r.framePerSecond),e._AddSplineTangent(Z.INTANGENT,s,n,"CUBICSPLINE",a,o),e._AddKeyframeValue(a,r,s,n,t,o),e._AddSplineTangent(Z.OUTTANGENT,s,n,"CUBICSPLINE",a,o)}))},e._GetBasePositionRotationOrScale=function(e,t,r){var n;if("rotation"===t)if(r){var i=e.rotationQuaternion;n=(null!=i?i:h.Quaternion.Identity()).asArray()}else{var s=e.rotation;n=(null!=s?s:h.Vector3.Zero()).asArray()}else if("translation"===t){var o=e.position;n=(null!=o?o:h.Vector3.Zero()).asArray()}else{var a=e.scaling;n=(null!=a?a:h.Vector3.One()).asArray()}return n},e._AddKeyframeValue=function(e,t,r,n,i,s){var o,a=t.dataType;if(a===h.Animation.ANIMATIONTYPE_VECTOR3){var u=e.value.asArray();if("rotation"===n){var c=h.Vector3.FromArray(u);u=h.Quaternion.RotationYawPitchRoll(c.y,c.x,c.z).asArray()}r.push(u)}else if(a===h.Animation.ANIMATIONTYPE_FLOAT){if("weights"===n)r.push([e.value]);else if(o=this._ConvertFactorToVector3OrQuaternion(e.value,i,t,n,s)){if("rotation"===n){var l=s?o:h.Quaternion.RotationYawPitchRoll(o.y,o.x,o.z).normalize();r.push(l.asArray())}r.push(o.asArray())}}else a===h.Animation.ANIMATIONTYPE_QUATERNION?r.push(e.value.normalize().asArray()):h.Tools.Error("glTFAnimation: Unsupported key frame values for animation!")},e._DeduceInterpolation=function(e,t,r){var n,i,s=!1;if("rotation"===t&&!r)return{interpolationType:"LINEAR",shouldBakeAnimation:!0};for(var o=0,a=e.length;o<a;++o)if((i=e[o]).inTangent||i.outTangent)if(n){if("CUBICSPLINE"!==n){n="LINEAR",s=!0;break}}else n="CUBICSPLINE";else if(n){if("CUBICSPLINE"===n||i.interpolation&&1===i.interpolation&&"STEP"!==n){n="LINEAR",s=!0;break}}else n=i.interpolation&&1===i.interpolation?"STEP":"LINEAR";return n||(n="LINEAR"),{interpolationType:n,shouldBakeAnimation:s}},e._AddSplineTangent=function(e,t,r,n,i,s){var o,a=e===Z.INTANGENT?i.inTangent:i.outTangent;if("CUBICSPLINE"===n){if("rotation"===r)if(a)if(s)o=a.asArray();else{var u=a;o=h.Quaternion.RotationYawPitchRoll(u.y,u.x,u.z).asArray()}else o=[0,0,0,0];else o="weights"===r?a?[a]:[0]:a?a.asArray():[0,0,0];t.push(o)}},e._CalculateMinMaxKeyFrames=function(e){var t=1/0,r=-1/0;return e.forEach((function(e){t=Math.min(t,e.frame),r=Math.max(r,e.frame)})),{min:t,max:r}},e}();function ee(e,t,r,n,i,s){var o={attributes:{},influence:e.influence,name:e.name},a=t.geometry;if(!a)return h.Tools.Warn("Attempted to export morph target data from a mesh without geometry. This should not happen."),o;var u=s?-1:1,c=h.Vector3.Zero(),l=0;if(e.hasPositions){var f=e.getPositions(),p=a.getVerticesData(h.VertexBuffer.PositionKind);if(p){var d=new Float32Array(p.length),_=[1/0,1/0,1/0],m=[-1/0,-1/0,-1/0];l=p.length/3;for(var g=0;g<l;++g){var x=h.Vector3.FromArray(p,3*g);h.Vector3.FromArray(f,3*g).subtractToRef(x,c),c.x*=u,_[0]=Math.min(_[0],c.x),m[0]=Math.max(m[0],c.x),_[1]=Math.min(_[1],c.y),m[1]=Math.max(m[1],c.y),_[2]=Math.min(_[2],c.z),m[2]=Math.max(m[2],c.z),d[3*g]=c.x,d[3*g+1]=c.y,d[3*g+2]=c.z}var y=r.createBufferView(d,12),v=r.createAccessor(y,"VEC3",5126,f.length/3,0,{min:_,max:m});i.push(v),o.attributes.POSITION=i.length-1}else h.Tools.Warn("Morph target positions for mesh ".concat(t.name," were not exported. Mesh does not have position vertex data"))}if(e.hasNormals){var T=e.getNormals(),b=a.getVerticesData(h.VertexBuffer.NormalKind);if(b){var w=new Float32Array(b.length);for(l=b.length/3,g=0;g<l;++g){var A=h.Vector3.FromArray(b,3*g).normalize();h.Vector3.FromArray(T,3*g).normalize().subtractToRef(A,c),w[3*g]=c.x*u,w[3*g+1]=c.y,w[3*g+2]=c.z}y=r.createBufferView(w,12),v=r.createAccessor(y,"VEC3",5126,T.length/3,0),i.push(v),o.attributes.NORMAL=i.length-1}else h.Tools.Warn("Morph target normals for mesh ".concat(t.name," were not exported. Mesh does not have normals vertex data"))}if(e.hasTangents){var E=e.getTangents(),M=a.getVerticesData(h.VertexBuffer.TangentKind);if(M){l=M.length/4;var R=new Float32Array(3*l);for(g=0;g<l;++g){var V=h.Vector3.FromArray(M,4*g);k(V);var C=h.Vector3.FromArray(E,3*g);k(C),C.subtractToRef(V,c),R[3*g]=c.x*u,R[3*g+1]=c.y,R[3*g+2]=c.z}y=r.createBufferView(R,12),v=r.createAccessor(y,"VEC3",5126,l,0),i.push(v),o.attributes.TANGENT=i.length-1}else h.Tools.Warn("Morph target tangents for mesh ".concat(t.name," were not exported. Mesh does not have tangents vertex data"))}if(e.hasColors){var S=e.getColors(),I=a.getVerticesData(h.VertexBuffer.ColorKind),B=a.getVertexBuffer(h.VertexBuffer.ColorKind);if(I&&B){var F=B.getSize();l=I.length/F;var N=new Float32Array(l*F);for(g=0;g<l;++g)if(3===F){var U=h.Vector3.FromArray(I,g*F);h.Vector3.FromArray(S,g*F).subtractToRef(U,c),N[3*g]=c.x,N[3*g+1]=c.y,N[3*g+2]=c.z}else if(4===F){var O=new h.Vector4;U=h.Vector4.FromArray(I,g*F),h.Vector4.FromArray(S,g*F).subtractToRef(U,O),N[4*g]=O.x,N[4*g+1]=O.y,N[4*g+2]=O.z,N[4*g+3]=O.w}else h.Tools.Warn("Unsupported number of components for color attribute: ".concat(F));y=r.createBufferView(N,4*F),v=r.createAccessor(y,3===F?"VEC3":"VEC4",5126,l,0),i.push(v),o.attributes.COLOR_0=i.length-1}else h.Tools.Warn("Morph target colors for mesh ".concat(t.name," were not exported. Mesh does not have colors vertex data"))}return o}var te=function(){function e(e,t){this._indicesAccessorMap=new Map,this._vertexBufferViewMap=new Map,this._vertexAccessorMap=new Map,this._remappedBufferView=new Map,this._meshMorphTargetMap=new Map,this._vertexMapColorAlpha=new Map,this._exportedNodes=new Set,this._meshMap=new Map,this.convertedToRightHandedBuffers=new Map,this.convertToRightHanded=e,this.wasAddedByNoopNode=t}return e.prototype.getIndicesAccessor=function(e,t,r,n,i){var s,o,a,u;return null===(u=null===(a=null===(o=null===(s=this._indicesAccessorMap.get(e))||void 0===s?void 0:s.get(t))||void 0===o?void 0:o.get(r))||void 0===a?void 0:a.get(n))||void 0===u?void 0:u.get(i)},e.prototype.setIndicesAccessor=function(e,t,r,n,i,s){var o=this._indicesAccessorMap.get(e);o||(o=new Map,this._indicesAccessorMap.set(e,o));var a=o.get(t);a||(a=new Map,o.set(t,a));var u=a.get(r);u||(u=new Map,a.set(r,u));var c=u.get(n);c||(c=new Map,u.set(n,c)),c.set(i,s)},e.prototype.pushExportedNode=function(e){this._exportedNodes.has(e)||this._exportedNodes.add(e)},e.prototype.getNodesSet=function(){return this._exportedNodes},e.prototype.getVertexBufferView=function(e){return this._vertexBufferViewMap.get(e)},e.prototype.setVertexBufferView=function(e,t){this._vertexBufferViewMap.set(e,t)},e.prototype.setRemappedBufferView=function(e,t,r){this._remappedBufferView.set(e,new Map),this._remappedBufferView.get(e).set(t,r)},e.prototype.getRemappedBufferView=function(e,t){var r;return null===(r=this._remappedBufferView.get(e))||void 0===r?void 0:r.get(t)},e.prototype.getVertexAccessor=function(e,t,r){var n,i;return null===(i=null===(n=this._vertexAccessorMap.get(e))||void 0===n?void 0:n.get(t))||void 0===i?void 0:i.get(r)},e.prototype.setVertexAccessor=function(e,t,r,n){var i=this._vertexAccessorMap.get(e);i||(i=new Map,this._vertexAccessorMap.set(e,i));var s=i.get(t);s||(s=new Map,i.set(t,s)),s.set(r,n)},e.prototype.hasVertexColorAlpha=function(e){return this._vertexMapColorAlpha.get(e)||!1},e.prototype.setHasVertexColorAlpha=function(e,t){return this._vertexMapColorAlpha.set(e,t)},e.prototype.getMesh=function(e){return this._meshMap.get(e)},e.prototype.setMesh=function(e,t){this._meshMap.set(e,t)},e.prototype.bindMorphDataToMesh=function(e,t){var r=this._meshMorphTargetMap.get(e)||[];this._meshMorphTargetMap.set(e,r),-1===r.indexOf(t)&&r.push(t)},e.prototype.getMorphTargetsFromMesh=function(e){return this._meshMorphTargetMap.get(e)},e}(),re=function(){function e(e,t){if(void 0===e&&(e=h.EngineStore.LastCreatedScene),this._glTF={asset:{generator:"Babylon.js v".concat(h.Engine.Version),version:"2.0"}},this._animations=[],this._accessors=[],this._bufferViews=[],this._cameras=[],this._images=[],this._materials=[],this._meshes=[],this._nodes=[],this._samplers=[],this._scenes=[],this._skins=[],this._textures=[],this._imageData={},this._shouldUseGlb=!1,this._materialExporter=new C(this),this._extensions={},this._bufferManager=new J,this._shouldExportNodeMap=new Map,this._nodeMap=new Map,this._materialMap=new Map,this._camerasMap=new Map,this._nodesCameraMap=new Map,this._skinMap=new Map,this._nodesSkinMap=new Map,this._materialNeedsUVsSet=new Set,!e)throw new Error("No scene available to export");this._babylonScene=e,this._options=d({shouldExportNode:function(){return!0},shouldExportAnimation:function(){return!0},metadataSelector:function(e){var t;return null===(t=null==e?void 0:e.gltf)||void 0===t?void 0:t.extras},animationSampleRate:1/60,exportWithoutWaitingForScene:!1,exportUnusedUVs:!1,removeNoopRootNodes:!0,includeCoordinateSystemConversionNodes:!1,meshCompressionMethod:"None"},t),this._loadExtensions()}return e.prototype._ApplyExtension=function(e,t,r,n){var i=this;if(r>=t.length)return Promise.resolve(e);var s=n(t[r],e);return s?s.then((function(e){return _(i,void 0,void 0,(function(){var i;return m(this,(function(s){switch(s.label){case 0:return e?[4,this._ApplyExtension(e,t,r+1,n)]:[3,2];case 1:return i=s.sent(),[3,3];case 2:i=null,s.label=3;case 3:return[2,i]}}))}))})):this._ApplyExtension(e,t,r+1,n)},e.prototype._ApplyExtensions=function(t,r){for(var n=[],i=0,s=e._ExtensionNames;i<s.length;i++){var o=s[i];n.push(this._extensions[o])}return this._ApplyExtension(t,n,0,r)},e.prototype._extensionsPostExportNodeAsync=function(e,t,r,n,i){var s=this;return this._ApplyExtensions(t,(function(t,o){return t.postExportNodeAsync&&t.postExportNodeAsync(e,o,r,n,i,s._bufferManager)}))},e.prototype._extensionsPostExportMaterialAsync=function(e,t,r){return this._ApplyExtensions(t,(function(t,n){return t.postExportMaterialAsync&&t.postExportMaterialAsync(e,n,r)}))},e.prototype._extensionsPostExportMaterialAdditionalTextures=function(t,r,n){for(var i=[],s=0,o=e._ExtensionNames;s<o.length;s++){var a=o[s],u=this._extensions[a];u.postExportMaterialAdditionalTextures&&i.push.apply(i,u.postExportMaterialAdditionalTextures(t,r,n))}return i},e.prototype._extensionsPostExportTextures=function(t,r,n){for(var i=0,s=e._ExtensionNames;i<s.length;i++){var o=s[i],a=this._extensions[o];a.postExportTexture&&a.postExportTexture(t,r,n)}},e.prototype._extensionsPostExportMeshPrimitive=function(t){for(var r=0,n=e._ExtensionNames;r<n.length;r++){var i=n[r],s=this._extensions[i];s.postExportMeshPrimitive&&s.postExportMeshPrimitive(t,this._bufferManager,this._accessors)}},e.prototype._extensionsPreGenerateBinaryAsync=function(){return _(this,void 0,void 0,(function(){var t,r,n,i;return m(this,(function(s){switch(s.label){case 0:t=0,r=e._ExtensionNames,s.label=1;case 1:return t<r.length?(n=r[t],(i=this._extensions[n]).preGenerateBinaryAsync?[4,i.preGenerateBinaryAsync(this._bufferManager)]:[3,3]):[3,4];case 2:s.sent(),s.label=3;case 3:return t++,[3,1];case 4:return[2]}}))}))},e.prototype._forEachExtensions=function(t){for(var r=0,n=e._ExtensionNames;r<n.length;r++){var i=n[r],s=this._extensions[i];s.enabled&&t(s)}},e.prototype._extensionsOnExporting=function(){var e=this;this._forEachExtensions((function(t){var r,n,i;t.wasUsed&&((r=e._glTF).extensionsUsed||(r.extensionsUsed=[]),-1===e._glTF.extensionsUsed.indexOf(t.name)&&e._glTF.extensionsUsed.push(t.name),t.required&&((n=e._glTF).extensionsRequired||(n.extensionsRequired=[]),-1===e._glTF.extensionsRequired.indexOf(t.name)&&e._glTF.extensionsRequired.push(t.name)),(i=e._glTF).extensions||(i.extensions={}),t.onExporting&&t.onExporting())}))},e.prototype._loadExtensions=function(){for(var t=0,r=e._ExtensionNames;t<r.length;t++){var n=r[t],i=e._ExtensionFactories[n](this);this._extensions[n]=i}},e.prototype.dispose=function(){for(var e in this._extensions)this._extensions[e].dispose()},Object.defineProperty(e.prototype,"options",{get:function(){return this._options},enumerable:!1,configurable:!0}),e.RegisterExtension=function(t,r){e.UnregisterExtension(t)&&h.Tools.Warn("Extension with the name ".concat(t," already exists")),e._ExtensionFactories[t]=r,e._ExtensionNames.push(t)},e.UnregisterExtension=function(t){if(!e._ExtensionFactories[t])return!1;delete e._ExtensionFactories[t];var r=e._ExtensionNames.indexOf(t);return-1!==r&&e._ExtensionNames.splice(r,1),!0},e.prototype._generateJSON=function(e,t,r){var n={byteLength:e};return n.byteLength&&(this._glTF.buffers=[n]),this._nodes&&this._nodes.length&&(this._glTF.nodes=this._nodes),this._meshes&&this._meshes.length&&(this._glTF.meshes=this._meshes),this._scenes&&this._scenes.length&&(this._glTF.scenes=this._scenes,this._glTF.scene=0),this._cameras&&this._cameras.length&&(this._glTF.cameras=this._cameras),this._bufferViews&&this._bufferViews.length&&(this._glTF.bufferViews=this._bufferViews),this._accessors&&this._accessors.length&&(this._glTF.accessors=this._accessors),this._animations&&this._animations.length&&(this._glTF.animations=this._animations),this._materials&&this._materials.length&&(this._glTF.materials=this._materials),this._textures&&this._textures.length&&(this._glTF.textures=this._textures),this._samplers&&this._samplers.length&&(this._glTF.samplers=this._samplers),this._skins&&this._skins.length&&(this._glTF.skins=this._skins),this._images&&this._images.length&&(this._glTF.images=this._images),this._shouldUseGlb||(n.uri=t+".bin"),r?JSON.stringify(this._glTF,null,2):JSON.stringify(this._glTF)},e.prototype.generateGLTFAsync=function(e){return _(this,void 0,void 0,(function(){var t,r,n,i,s,o,a;return m(this,(function(u){switch(u.label){case 0:return[4,this._generateBinaryAsync()];case 1:if(t=u.sent(),this._extensionsOnExporting(),r=this._generateJSON(t.byteLength,e,!0),n=new Blob([t],{type:"application/octet-stream"}),i=e+".gltf",s=e+".bin",(o=new p).files[i]=r,o.files[s]=n,this._imageData)for(a in this._imageData)o.files[a]=new Blob([this._imageData[a].data],{type:this._imageData[a].mimeType});return[2,o]}}))}))},e.prototype._generateBinaryAsync=function(){return _(this,void 0,void 0,(function(){return m(this,(function(e){switch(e.label){case 0:return[4,this._exportSceneAsync()];case 1:return e.sent(),[4,this._extensionsPreGenerateBinaryAsync()];case 2:return e.sent(),[2,this._bufferManager.generateBinary(this._bufferViews)]}}))}))},e.prototype._getPadding=function(e){var t=e%4;return 0===t?t:4-t},e.prototype.generateGLBAsync=function(e){return _(this,void 0,void 0,(function(){var t,r,n,i,s,o,a,u,c,l,f,h,d,_;return m(this,(function(m){switch(m.label){case 0:return this._shouldUseGlb=!0,[4,this._generateBinaryAsync()];case 1:if(t=m.sent(),this._extensionsOnExporting(),r=this._generateJSON(t.byteLength),n=e+".glb",i=r.length,"undefined"!=typeof TextEncoder&&(o=new TextEncoder,s=o.encode(r),i=s.length),a=this._getPadding(i),u=this._getPadding(t.byteLength),c=28+i+a+t.byteLength+u,(l=new X(c)).writeUInt32(1179937895),l.writeUInt32(2),l.writeUInt32(c),l.writeUInt32(i+a),l.writeUInt32(1313821514),s)l.writeTypedArray(s);else for(f="_".charCodeAt(0),d=0;d<i;++d)(h=r.charCodeAt(d))!=r.codePointAt(d)?l.writeUInt8(f):l.writeUInt8(h);for(d=0;d<a;++d)l.writeUInt8(32);for(l.writeUInt32(t.byteLength+u),l.writeUInt32(5130562),l.writeTypedArray(t),d=0;d<u;++d)l.writeUInt8(0);return(_=new p).files[n]=new Blob([l.getOutputData()],{type:"application/octet-stream"}),[2,_]}}))}))},e.prototype._setNodeTransformation=function(e,t,r){var n;if(t.getPivotPoint().equalsWithEpsilon(B,h.Epsilon)||h.Tools.Warn("Pivot points are not supported in the glTF serializer"),!t.position.equalsWithEpsilon(B,h.Epsilon)){var i=h.TmpVectors.Vector3[0].copyFrom(t.position);r&&D(i),e.translation=i.asArray()}t.scaling.equalsWithEpsilon(N,h.Epsilon)||(e.scale=t.scaling.asArray());var s=(null===(n=t.rotationQuaternion)||void 0===n?void 0:n.clone())||h.Quaternion.FromEulerAngles(t.rotation.x,t.rotation.y,t.rotation.z);s.equalsWithEpsilon(F,h.Epsilon)||(r&&G(s),e.rotation=s.normalize().asArray())},e.prototype._setCameraTransformation=function(e,t,r){if(!t.position.equalsWithEpsilon(B,h.Epsilon)){var n=h.TmpVectors.Vector3[0].copyFrom(t.position);r&&D(n),e.translation=n.asArray()}var i=t.rotationQuaternion||h.Quaternion.FromEulerAngles(t.rotation.x,t.rotation.y,t.rotation.z);r&&G(i),this._babylonScene.useRightHandedSystem||H(i),i.equalsWithEpsilon(F,h.Epsilon)||(e.rotation=i.asArray())},e.prototype._listAvailableCameras=function(){for(var e=0,t=this._babylonScene.cameras;e<t.length;e++){var r=t[e],n={type:r.mode===h.Camera.PERSPECTIVE_CAMERA?"perspective":"orthographic"};if(r.name&&(n.name=r.name),"perspective"===n.type)n.perspective={aspectRatio:r.getEngine().getAspectRatio(r),yfov:r.fovMode===h.Camera.FOVMODE_VERTICAL_FIXED?r.fov:r.fov*r.getEngine().getAspectRatio(r),znear:r.minZ,zfar:r.maxZ};else if("orthographic"===n.type){var i=r.orthoLeft&&r.orthoRight?.5*(r.orthoRight-r.orthoLeft):.5*r.getEngine().getRenderWidth(),s=r.orthoBottom&&r.orthoTop?.5*(r.orthoTop-r.orthoBottom):.5*r.getEngine().getRenderHeight();n.orthographic={xmag:i,ymag:s,znear:r.minZ,zfar:r.maxZ}}this._camerasMap.set(r,n)}},e.prototype._exportAndAssignCameras=function(){for(var e=0,t=Array.from(this._camerasMap.values());e<t.length;e++){var r=t[e],n=this._nodesCameraMap.get(r);if(void 0!==n){this._cameras.push(r);for(var i=0,s=n;i<s.length;i++)s[i].camera=this._cameras.length-1}}},e.prototype._listAvailableSkeletons=function(){for(var e=0,t=this._babylonScene.skeletons;e<t.length;e++){var r=t[e];r.bones.length<=0||this._skinMap.set(r,{joints:[]})}},e.prototype._exportAndAssignSkeletons=function(e){for(var t,r=function(r){if(r.bones.length<=0)return"continue";var i=n._skinMap.get(r);if(null==i)return"continue";for(var s={},o=-1,a=0;a<r.bones.length;++a){var u=r.bones[a];-1!==(f=null!==(t=u.getIndex())&&void 0!==t?t:a)&&(s[f]=u,f>o&&(o=f))}for(var c,l=[],f=0;f<=o;++f){var p=(u=s[f]).getTransformNode(),d=p?n._nodeMap.get(p):void 0;if(void 0!==d){i.joints.push(d);var _=u.getAbsoluteInverseBindMatrix().clone();e.has(p)&&(c=_,S.invertToRef(h.TmpVectors.Matrix[0]).multiplyToRef(c,c).multiplyToRef(S,c)),l.push(_)}else h.Tools.Warn("Exporting a bone without a linked transform node is currently unsupported.")}var m=n._nodesSkinMap.get(i);if(i.joints.length>0&&void 0!==m){var g=new Float32Array(16*l.length);l.forEach((function(e,t){g.set(e.m,16*t)}));var x=n._bufferManager.createBufferView(g);n._accessors.push(n._bufferManager.createAccessor(x,"MAT4",5126,l.length)),i.inverseBindMatrices=n._accessors.length-1,n._skins.push(i);for(var y=n._skins.length-1,v=0,T=m;v<T.length;v++)T[v].skin=y}},n=this,i=0,s=this._babylonScene.skeletons;i<s.length;i++)r(s[i])},e.prototype._exportSceneAsync=function(){return _(this,void 0,void 0,(function(){var e,t,r,n,i,s,o,a,u,c,l,f,h,p,d,_,g,x,y,v,T,b,w;return m(this,(function(m){switch(m.label){case 0:for(e={nodes:[]},this._babylonScene.metadata&&(t=this._options.metadataSelector(this._babylonScene.metadata))&&(e.extras=t),r=new Array,n=new Array,i=new Array,s=0,o=this._babylonScene.rootNodes;s<o.length;s++)a=o[s],this._options.removeNoopRootNodes&&!this._options.includeCoordinateSystemConversionNodes&&I(a,this._babylonScene.useRightHandedSystem)?i.push.apply(i,a.getChildren()):this._babylonScene.useRightHandedSystem?r.push(a):n.push(a);return this._listAvailableCameras(),this._listAvailableSkeletons(),u=new te(!0,!1),l=(c=(T=e.nodes).push).apply,f=[T],[4,this._exportNodesAsync(n,u)];case 1:return l.apply(c,f.concat([m.sent()])),h=new te(!1,!1),d=(p=(b=e.nodes).push).apply,_=[b],[4,this._exportNodesAsync(r,h)];case 2:return d.apply(p,_.concat([m.sent()])),g=new te(!1,!0),y=(x=(w=e.nodes).push).apply,v=[w],[4,this._exportNodesAsync(i,g)];case 3:return y.apply(x,v.concat([m.sent()])),e.nodes.length&&this._scenes.push(e),this._exportAndAssignCameras(),this._exportAndAssignSkeletons(u.getNodesSet()),this._babylonScene.animationGroups.length&&$._CreateNodeAndMorphAnimationFromAnimationGroups(this._babylonScene,this._animations,this._nodeMap,this._bufferManager,this._bufferViews,this._accessors,this._animationSampleRate,u.getNodesSet(),this._options.shouldExportAnimation),[2]}}))}))},e.prototype._shouldExportNode=function(e){var t=this._shouldExportNodeMap.get(e);return void 0===t&&(t=this._options.shouldExportNode(e),this._shouldExportNodeMap.set(e,t)),t},e.prototype._exportNodesAsync=function(e,t){return _(this,void 0,void 0,(function(){var r,n,i,s;return m(this,(function(o){switch(o.label){case 0:r=new Array,this._exportBuffers(e,t),n=0,i=e,o.label=1;case 1:return n<i.length?(s=i[n],[4,this._exportNodeAsync(s,r,t)]):[3,4];case 2:o.sent(),o.label=3;case 3:return n++,[3,1];case 4:return[2,r]}}))}))},e.prototype._collectBuffers=function(e,t,r,n,i){if(this._shouldExportNode(e)&&e instanceof h.AbstractMesh&&e.geometry){var s=e.geometry.getVertexBuffers();if(s)for(var o in s)if(L(o)){var a=s[o];i.setHasVertexColorAlpha(a,e.hasVertexAlpha);var u=a._buffer,c=t.get(u)||[];t.set(u,c),-1===c.indexOf(a)&&c.push(a);var l=r.get(a)||[];r.set(a,l),-1===l.indexOf(e)&&l.push(e)}var f=e.morphTargetManager;if(f)for(var p=0;p<f.numTargets;p++){var d=f.getTarget(p);l=n.get(d)||[],n.set(d,l),-1===l.indexOf(e)&&l.push(e)}}for(var _=0,m=e.getChildren();_<m.length;_++){var g=m[_];this._collectBuffers(g,t,r,n,i)}},e.prototype._exportBuffers=function(e,t){for(var r=new Map,n=new Map,i=new Map,s=0,o=e;s<o.length;s++){var a=o[s];this._collectBuffers(a,r,n,i,t)}for(var u=Array.from(r.keys()),c=function(e){var i=e.getData();if(!i)throw new Error("Buffer data is not available");var s=r.get(e);if(!s)return"continue";var o=s[0].byteStride;if(s.some((function(e){return e.byteStride!==o})))throw new Error("Vertex buffers pointing to the same buffer must have the same byte stride");for(var a=function(e){if(e instanceof Array){var t=new Float32Array(e);return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}return ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}(i).slice(),u=function(e){var t=n.get(e),r=O(e,t),i=r.byteOffset,s=r.byteStride,o=r.componentCount,u=r.type,c=r.count,f=r.normalized;switch(r.kind){case h.VertexBuffer.NormalKind:case h.VertexBuffer.TangentKind:(0,h.EnumerateFloatValues)(a,i,s,o,u,c,f,(function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);if(t>0){var r=1/t;e[0]*=r,e[1]*=r,e[2]*=r}}));break;case h.VertexBuffer.ColorKind:var p=t.filter((function(e){return e.material instanceof h.StandardMaterial||null==e.material})).length;if(0==p)break;if(p!=t.length){h.Logger.Warn("Not converting vertex color space, as buffer is shared by StandardMaterials and other material types. Results may look incorrect.");break}u==h.VertexBuffer.UNSIGNED_BYTE&&h.Logger.Warn("Converting uint8 vertex colors to linear space. Results may look incorrect.");var d=new h.Color3,_=new h.Color4,m=l._babylonScene.getEngine().useExactSrgbConversions;(0,h.EnumerateFloatValues)(a,i,s,o,u,c,f,(function(e){3===e.length?(d.fromArray(e,0),d.toLinearSpaceToRef(d,m),d.toArray(e,0)):(_.fromArray(e,0),_.toLinearSpaceToRef(_,m),_.toArray(e,0))}))}},c=0,f=s;c<f.length;c++)u(B=f[c]);if(t.convertToRightHanded){for(var p=0,d=s;p<d.length;p++){var _=O(B=d[p],n.get(B)),m=_.byteOffset,g=_.byteStride,x=_.componentCount,y=_.type,v=_.count,T=_.normalized;switch(R=_.kind){case h.VertexBuffer.PositionKind:case h.VertexBuffer.NormalKind:case h.VertexBuffer.TangentKind:(0,h.EnumerateFloatValues)(a,m,g,x,y,v,T,(function(e){e[0]=-e[0]}))}}t.convertedToRightHandedBuffers.set(e,a)}var b=l._bufferManager.createBufferView(a,o);t.setVertexBufferView(e,b);for(var w=new Map,A=0,E=s;A<E.length;A++){var M=O(B=E[A],n.get(B)),R=M.kind,V=M.totalVertices;switch(R){case h.VertexBuffer.MatricesIndicesKind:case h.VertexBuffer.MatricesIndicesExtraKind:if(B.type==h.VertexBuffer.FLOAT){var C=B.getFloatData(V);null!==C&&w.set(B,C)}}}0!==w.size&&h.Logger.Warn("Joint indices conversion needed: some joint indices are stored as floats in Babylon but GLTF requires UNSIGNED BYTES. We will perform the conversion but this might lead to unused data in the buffer.");for(var S=0,I=Array.from(w.keys());S<I.length;S++){var B=I[S],F=w.get(B);if(F){for(var N=F.some((function(e){return e>=256})),U=new(N?Uint16Array:Uint8Array)(F.length),P=0;P<F.length;P++)U[P]=F[P];var L=l._bufferManager.createBufferView(U,4*(N?2:1));t.setRemappedBufferView(e,B,L)}}},l=this,f=0,p=u;f<p.length;f++)c(p[f]);for(var d=0,_=Array.from(i.keys());d<_.length;d++){var m=_[d],g=i.get(m);if(g)for(var x=ee(m,g[0],this._bufferManager,this._bufferViews,this._accessors,t.convertToRightHanded),y=0,v=g;y<v.length;y++){var T=v[y];t.bindMorphDataToMesh(T,x)}}},e.prototype._exportNodeAsync=function(e,t,r){return _(this,void 0,void 0,(function(){var n,i,s,o,a,u,c,l,f=this;return m(this,(function(h){switch(h.label){case 0:return void 0!==(n=this._nodeMap.get(e))?(t.includes(n)||t.push(n),[2]):[4,this._createNodeAsync(e,r)];case 1:(i=h.sent())&&(n=this._nodes.length,this._nodes.push(i),this._nodeMap.set(e,n),r.pushExportedNode(e),t.push(n),s={name:"runtime animations",channels:[],samplers:[]},o=[],this._babylonScene.animationGroups.length||($._CreateMorphTargetAnimationFromMorphTargetAnimations(e,s,o,this._nodeMap,this._nodes,this._bufferManager,this._bufferViews,this._accessors,this._animationSampleRate,r.convertToRightHanded,this._options.shouldExportAnimation),e.animations.length&&$._CreateNodeAnimationFromNodeAnimations(e,s,o,this._nodeMap,this._nodes,this._bufferManager,this._bufferViews,this._accessors,this._animationSampleRate,r.convertToRightHanded,this._options.shouldExportAnimation)),s.channels.length&&s.samplers.length&&this._animations.push(s),o.forEach((function(e){e.channels.length&&e.samplers.length&&f._animations.push(e)}))),a=i?[]:t,u=0,c=e.getChildren(),h.label=2;case 2:return u<c.length?(l=c[u],[4,this._exportNodeAsync(l,a,r)]):[3,5];case 3:h.sent(),h.label=4;case 4:return u++,[3,2];case 5:return i&&a.length&&(i.children=a),[2]}}))}))},e.prototype._createNodeAsync=function(e,t){return _(this,void 0,void 0,(function(){var r,n,i,s,o,a,u,c,l,f,p,d;return m(this,(function(_){switch(_.label){case 0:return this._shouldExportNode(e)?(r={},e.name&&(r.name=e.name),e.metadata&&(n=this._options.metadataSelector(e.metadata))&&(r.extras=n),e instanceof h.TransformNode?(this._setNodeTransformation(r,e,t.convertToRightHanded),e instanceof h.AbstractMesh?(i=e instanceof h.InstancedMesh?e.sourceMesh:e).subMeshes&&i.subMeshes.length>0?(s=r,[4,this._exportMeshAsync(i,t)]):[3,2]:[3,3]):[3,3]):[2,null];case 1:s.mesh=_.sent(),_.label=2;case 2:e.skeleton&&void 0!==(o=this._skinMap.get(e.skeleton))&&(void 0===this._nodesSkinMap.get(o)&&this._nodesSkinMap.set(o,[]),null===(f=this._nodesSkinMap.get(o))||void 0===f||f.push(r)),_.label=3;case 3:if(e instanceof h.TargetCamera&&(a=this._camerasMap.get(e))){if(void 0===this._nodesCameraMap.get(a)&&this._nodesCameraMap.set(a,[]),this._setCameraTransformation(r,e,t.convertToRightHanded),null!==(u=e.parent)&&q(e,u)&&void 0!==(c=this._nodeMap.get(u)))return l=this._nodes[c],W(r,l),null===(p=this._nodesCameraMap.get(a))||void 0===p||p.push(l),[2,null];null===(d=this._nodesCameraMap.get(a))||void 0===d||d.push(r)}return[4,this._extensionsPostExportNodeAsync("exportNodeAsync",r,e,this._nodeMap,t.convertToRightHanded)];case 4:return _.sent()?[2,r]:(h.Logger.Warn("Not exporting node ".concat(e.name)),[2,null])}}))}))},e.prototype._exportIndices=function(e,t,r,n,i,s,o,a,u){var c=e;u.mode=K(s);var l=o!==h.Material.CounterClockWiseSideOrientation&&function(e){switch(e){case h.Material.TriangleFillMode:case h.Material.TriangleStripDrawMode:case h.Material.TriangleFanDrawMode:return!0}return!1}(s);if(l){if(s===h.Material.TriangleStripDrawMode||s===h.Material.TriangleFanDrawMode)throw new Error("Triangle strip/fan fill mode is not implemented");u.mode=K(s);var f=t?new Uint32Array(n):new Uint16Array(n);if(e)for(var p=0;p+2<n;p+=3)f[p]=e[r+p]+i,f[p+1]=e[r+p+2]+i,f[p+2]=e[r+p+1]+i;else for(p=0;p+2<n;p+=3)f[p]=p,f[p+1]=p+2,f[p+2]=p+1;c=f}else if(e&&0!==i){for(f=t?new Uint32Array(n):new Uint16Array(n),p=0;p<n;p++)f[p]=e[r+p]+i;c=f}if(c){var d=a.getIndicesAccessor(e,r,n,i,l);if(void 0===d){var _=function(e,t,r,n){if(e instanceof Uint16Array||e instanceof Uint32Array)return e;if(e instanceof Int32Array)return new Uint32Array(e.buffer,e.byteOffset,e.length);var i=e.slice(0,0+r);return n?new Uint32Array(i):new Uint16Array(i)}(c,0,n,t),m=this._bufferManager.createBufferView(_),g=t?5125:5123;this._accessors.push(this._bufferManager.createAccessor(m,"SCALAR",g,n,0)),d=this._accessors.length-1,a.setIndicesAccessor(e,r,n,i,l,d)}u.indices=d}},e.prototype._exportVertexBuffer=function(e,t,r,n,i,s){var o=e.getKind();if(L(o)&&(!o.startsWith("uv")||this._options.exportUnusedUVs||t&&this._materialNeedsUVsSet.has(t))){var a=i.getVertexAccessor(e,r,n);if(void 0===a){var u=i.convertedToRightHandedBuffers.get(e._buffer)||e._buffer.getData(),c=o===h.VertexBuffer.PositionKind?function(e,t,r,n){var i=t.byteOffset,s=t.byteStride,o=t.type,a=t.normalized,u=t.getSize(),c=new Array(u).fill(1/0),l=new Array(u).fill(-1/0);return(0,h.EnumerateFloatValues)(e,i+r*s,s,u,o,n*u,a,(function(e){for(var t=0;t<u;t++)c[t]=Math.min(c[t],e[t]),l[t]=Math.max(l[t],e[t])})),{min:c,max:l}}(u,e,r,n):void 0,l=(o===h.VertexBuffer.MatricesIndicesKind||o===h.VertexBuffer.MatricesIndicesExtraKind)&&e.type===h.VertexBuffer.FLOAT,f=l?h.VertexBuffer.UNSIGNED_BYTE:e.type,p=l?void 0:e.normalized,d=l?i.getRemappedBufferView(e._buffer,e):i.getVertexBufferView(e._buffer),_=e.byteOffset+r*e.byteStride;this._accessors.push(this._bufferManager.createAccessor(d,function(e,t){if(e==h.VertexBuffer.ColorKind)return t?"VEC4":"VEC3";switch(e){case h.VertexBuffer.PositionKind:case h.VertexBuffer.NormalKind:return"VEC3";case h.VertexBuffer.TangentKind:case h.VertexBuffer.MatricesIndicesKind:case h.VertexBuffer.MatricesIndicesExtraKind:case h.VertexBuffer.MatricesWeightsKind:case h.VertexBuffer.MatricesWeightsExtraKind:return"VEC4";case h.VertexBuffer.UVKind:case h.VertexBuffer.UV2Kind:case h.VertexBuffer.UV3Kind:case h.VertexBuffer.UV4Kind:case h.VertexBuffer.UV5Kind:case h.VertexBuffer.UV6Kind:return"VEC2"}throw new Error("Unknown kind ".concat(e))}(o,i.hasVertexColorAlpha(e)),f,n,_,c,p)),a=this._accessors.length-1,i.setVertexAccessor(e,r,n,a)}s.attributes[function(e){switch(e){case h.VertexBuffer.PositionKind:return"POSITION";case h.VertexBuffer.NormalKind:return"NORMAL";case h.VertexBuffer.TangentKind:return"TANGENT";case h.VertexBuffer.ColorKind:return"COLOR_0";case h.VertexBuffer.UVKind:return"TEXCOORD_0";case h.VertexBuffer.UV2Kind:return"TEXCOORD_1";case h.VertexBuffer.UV3Kind:return"TEXCOORD_2";case h.VertexBuffer.UV4Kind:return"TEXCOORD_3";case h.VertexBuffer.UV5Kind:return"TEXCOORD_4";case h.VertexBuffer.UV6Kind:return"TEXCOORD_5";case h.VertexBuffer.MatricesIndicesKind:return"JOINTS_0";case h.VertexBuffer.MatricesIndicesExtraKind:return"JOINTS_1";case h.VertexBuffer.MatricesWeightsKind:return"WEIGHTS_0";case h.VertexBuffer.MatricesWeightsExtraKind:return"WEIGHTS_1"}throw new Error("Unknown kind: ".concat(e))}(o)]=a}},e.prototype._exportMaterialAsync=function(e,t,r,n){return _(this,void 0,void 0,(function(){var i,s;return m(this,(function(o){switch(o.label){case 0:return void 0!==(i=this._materialMap.get(e))?[3,6]:(s=t&&Object.keys(t).some((function(e){return e.startsWith("uv")})),(e=e instanceof h.MultiMaterial?e.subMaterials[r.materialIndex]:e)instanceof h.PBRBaseMaterial?[4,this._materialExporter.exportPBRMaterialAsync(e,s)]:[3,2]);case 1:return i=o.sent(),[3,5];case 2:return e instanceof h.StandardMaterial?[4,this._materialExporter.exportStandardMaterialAsync(e,s)]:[3,4];case 3:return i=o.sent(),[3,5];case 4:return h.Logger.Warn("Unsupported material '".concat(e.name,"' with type ").concat(e.getClassName())),[2];case 5:this._materialMap.set(e,i),o.label=6;case 6:return n.material=i,[2]}}))}))},e.prototype._exportMeshAsync=function(e,t){return _(this,void 0,void 0,(function(){var r,n,i,s,o,a,u,c,l,f,p,d,_,x,y,v,T,b,w,A,E,M,R,V,C,S,I,B,F,N,U,O,P,L;return m(this,(function(m){switch(m.label){case 0:if(void 0!==(r=t.getMesh(e)))return[2,r];if(n={primitives:[]},r=this._meshes.length,this._meshes.push(n),t.setMesh(e,r),i=e.isUnIndexed?null:e.getIndices(),s=null===(F=e.geometry)||void 0===F?void 0:F.getVertexBuffers(),o=t.getMorphTargetsFromMesh(e),a=e instanceof h.LinesMesh,u=e instanceof h.GreasedLineBaseMesh,c=e.subMeshes,!(s&&c&&c.length>0))return[3,7];l=0,f=c,m.label=1;case 1:return l<f.length?(p=f[l],d={attributes:{}},_=p.getMaterial()||this._babylonScene.defaultMaterial,u?(T={name:_.name},b=e,x=h.Color3.White(),y=null!==(U=null===(N=b.material)||void 0===N?void 0:N.alpha)&&void 0!==U?U:1,(!(v=null!==(P=null===(O=b.greasedLineMaterial)||void 0===O?void 0:O.color)&&void 0!==P?P:x).equalsWithEpsilon(x,h.Epsilon)||y<1)&&(T.pbrMetallicRoughness={baseColorFactor:g(g([],v.asArray(),!0),[y],!1)}),this._materials.push(T),d.material=this._materials.length-1,[3,5]):[3,2]):[3,7];case 2:return a?(T={name:_.name},(!(b=e).color.equalsWithEpsilon(h.Color3.White(),h.Epsilon)||b.alpha<1)&&(T.pbrMetallicRoughness={baseColorFactor:g(g([],b.color.asArray(),!0),[b.alpha],!1)}),this._materials.push(T),d.material=this._materials.length-1,[3,5]):[3,3];case 3:return[4,this._exportMaterialAsync(_,s,p,d)];case 4:m.sent(),m.label=5;case 5:for(w=a||u?h.Material.LineListDrawMode:null!==(L=e.overrideRenderingFillMode)&&void 0!==L?L:_.fillMode,A=_._getEffectiveOrientation(e),t.wasAddedByNoopNode&&!e.getScene().useRightHandedSystem&&(A=A===h.Material.ClockWiseSideOrientation?h.Material.CounterClockWiseSideOrientation:h.Material.ClockWiseSideOrientation),this._exportIndices(i,i?(0,h.AreIndices32Bits)(i,p.indexCount,p.indexStart,p.verticesStart):p.verticesCount>65535,i?p.indexStart:p.verticesStart,i?p.indexCount:p.verticesCount,-p.verticesStart,w,A,t,d),E=0,M=Object.values(s);E<M.length;E++)R=M[E],this._exportVertexBuffer(R,_,p.verticesStart,p.verticesCount,t,d);if(o)for(d.targets=[],V=0,C=o;V<C.length;V++)B=C[V],d.targets.push(B.attributes);n.primitives.push(d),this._extensionsPostExportMeshPrimitive(d),m.label=6;case 6:return l++,[3,1];case 7:if(o)for(n.weights=[],n.extras||(n.extras={}),n.extras.targetNames=[],S=0,I=o;S<I.length;S++)B=I[S],n.weights.push(B.influence),n.extras.targetNames.push(B.name);return[2,r]}}))}))},e._ExtensionNames=new Array,e._ExtensionFactories={},e}(),ne=function(){function e(){}return e.GLTFAsync=function(e,t,r){return _(this,void 0,void 0,(function(){var n,i;return m(this,(function(s){switch(s.label){case 0:return r&&r.exportWithoutWaitingForScene?[3,2]:[4,e.whenReadyAsync()];case 1:s.sent(),s.label=2;case 2:return[4,(n=new re(e,r)).generateGLTFAsync(t.replace(/\.[^/.]+$/,""))];case 3:return i=s.sent(),n.dispose(),[2,i]}}))}))},e.GLBAsync=function(e,t,r){return _(this,void 0,void 0,(function(){var n,i;return m(this,(function(s){switch(s.label){case 0:return r&&r.exportWithoutWaitingForScene?[3,2]:[4,e.whenReadyAsync()];case 1:s.sent(),s.label=2;case 2:return[4,(n=new re(e,r)).generateGLBAsync(t.replace(/\.[^/.]+$/,""))];case 3:return i=s.sent(),n.dispose(),[2,i]}}))}))},e}(),ie="EXT_mesh_gpu_instancing",se=function(){function e(e){this.name=ie,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportNodeAsync=function(e,t,r,n,i,s){return _(this,void 0,void 0,(function(){var e=this;return m(this,(function(n){switch(n.label){case 0:return[4,new Promise((function(n){if(t&&r instanceof h.Mesh&&r.hasThinInstances&&e._exporter){e._wasUsed=!0;for(var o=h.Vector3.Zero(),a=h.Quaternion.Identity(),u=h.Vector3.One(),c=r.thinInstanceGetWorldMatrices(),l=h.TmpVectors.Vector3[2],f=h.TmpVectors.Quaternion[1],p=h.TmpVectors.Vector3[3],d=!1,_=!1,m=!1,g=new Float32Array(3*r.thinInstanceCount),x=new Float32Array(4*r.thinInstanceCount),y=new Float32Array(3*r.thinInstanceCount),v=0,T=0,b=c;T<b.length;T++)b[T].decompose(p,f,l),i&&(D(l),G(f)),g.set(l.asArray(),3*v),x.set(f.normalize().asArray(),4*v),y.set(p.asArray(),3*v),d=d||!l.equalsWithEpsilon(o),_=_||!f.equalsWithEpsilon(a),m=m||!p.equalsWithEpsilon(u),v++;var w={attributes:{}};d&&(w.attributes.TRANSLATION=e._buildAccessor(g,"VEC3",r.thinInstanceCount,s)),_&&(w.attributes.ROTATION=e._buildAccessor(x,"VEC4",r.thinInstanceCount,s)),m&&(w.attributes.SCALE=e._buildAccessor(y,"VEC3",r.thinInstanceCount,s)),t.extensions=t.extensions||{},t.extensions[ie]=w}n(t)}))];case 1:return[2,n.sent()]}}))}))},e.prototype._buildAccessor=function(e,t,r,n){var i=n.createBufferView(e),s=n.createAccessor(i,t,5126,r);return this._exporter._accessors.push(s),this._exporter._accessors.length-1},e}();re.RegisterExtension(ie,(function(e){return new se(e)}));var oe="KHR_draco_mesh_compression",ae=function(){function e(e){this.name=oe,this.required=!0,this._bufferViewsUsed=new Set,this._accessorsUsed=new Set,this._encodePromises=[],this._wasUsed=!1,this.enabled="Draco"===e.options.meshCompressionMethod&&h.DracoEncoder.DefaultAvailable}return Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){},e.prototype.postExportMeshPrimitive=function(e,t,r){var n=this;if(this.enabled)if(4===e.mode||5===e.mode){var i=[],s=[],o=null;if(void 0!==e.indices){var a=r[e.indices],u=t.getBufferView(a);o=t.getData(u).slice(),i.push(u),s.push(a)}for(var c,l=[],f=0,p=Object.entries(e.attributes);f<p.length;f++){var d=p[f],_=d[0],m=(a=r[d[1]],u=t.getBufferView(a),P(a.type)),g=(0,h.GetTypedArrayData)(t.getData(u),m,a.componentType,a.byteOffset||0,u.byteStride||(0,h.GetTypeByteLength)(a.componentType)*m,a.normalized||!1,a.count,!0);l.push({kind:_,dracoName:(c=_,"POSITION"===c?"POSITION":"NORMAL"===c?"NORMAL":c.startsWith("COLOR")?"COLOR":c.startsWith("TEXCOORD")?"TEX_COORD":"GENERIC"),size:P(a.type),data:g}),i.push(u),s.push(a)}var x={method:e.targets?"MESH_SEQUENTIAL_ENCODING":"MESH_EDGEBREAKER_ENCODING"},y=h.DracoEncoder.Default._encodeAsync(l,o,x).then((function(r){if(r){var o={bufferView:-1,attributes:r.attributeIds},a=t.createBufferView(r.data);t.setBufferView(o,a);for(var u=0,c=i;u<c.length;u++){var l=c[u];n._bufferViewsUsed.add(l)}for(var f=0,p=s;f<p.length;f++){var d=p[f];n._accessorsUsed.add(d)}e.extensions||(e.extensions={}),e.extensions[oe]=o}else h.Logger.Error("Draco encoding failed for primitive.")})).catch((function(e){h.Logger.Error("Draco encoding failed for primitive: "+e)}));this._encodePromises.push(y),this._wasUsed=!0}else h.Logger.Warn("Cannot compress primitive with mode "+e.mode+".")},e.prototype.preGenerateBinaryAsync=function(e){return _(this,void 0,void 0,(function(){var t=this;return m(this,(function(r){switch(r.label){case 0:return this.enabled?[4,Promise.all(this._encodePromises)]:[2];case 1:return r.sent(),this._bufferViewsUsed.forEach((function(r){e.getPropertiesWithBufferView(r).every((function(e){return t._accessorsUsed.has(e)}))&&e.removeBufferView(r)})),this._bufferViewsUsed.clear(),this._accessorsUsed.clear(),[2]}}))}))},e}();re.RegisterExtension(oe,(function(e){return new ae(e)}));var ue="KHR_lights_punctual",ce={name:"",color:[1,1,1],intensity:1,range:Number.MAX_VALUE},le={innerConeAngle:0,outerConeAngle:Math.PI/4},fe=h.Vector3.Backward(),he=function(){function e(e){this.name=ue,this.enabled=!0,this.required=!1,this._exporter=e}return e.prototype.dispose=function(){this._lights=null},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return!!this._lights},enumerable:!1,configurable:!0}),e.prototype.onExporting=function(){this._exporter._glTF.extensions[ue]=this._lights},e.prototype.postExportNodeAsync=function(e,t,r,n,i){return _(this,void 0,void 0,(function(){var s=this;return m(this,(function(o){switch(o.label){case 0:return[4,new Promise((function(o){if(r instanceof h.Light){var a=r.getTypeID()==h.Light.LIGHTTYPEID_POINTLIGHT?"point":r.getTypeID()==h.Light.LIGHTTYPEID_DIRECTIONALLIGHT?"directional":r.getTypeID()==h.Light.LIGHTTYPEID_SPOTLIGHT?"spot":null;if(!(a&&r instanceof h.ShadowLight))return h.Logger.Warn("".concat(e,": Light ").concat(r.name," is not supported in ").concat(ue)),void o(t);if(r.falloffType!==h.Light.FALLOFF_GLTF&&h.Logger.Warn("".concat(e,": Light falloff for ").concat(r.name," does not match the ").concat(ue," specification!")),!r.position.equalsToFloats(0,0,0)){var u=h.TmpVectors.Vector3[0].copyFrom(r.position);i&&D(u),t.translation=u.asArray()}if("point"!==a){var c=r.direction.normalizeToRef(h.TmpVectors.Vector3[0]);i&&D(c);var l=h.Quaternion.FromUnitVectorsToRef(fe,c,h.TmpVectors.Quaternion[0]);h.Quaternion.IsIdentity(l)||(t.rotation=l.asArray())}var f={type:a,name:r.name,color:r.diffuse.asArray(),intensity:r.intensity,range:r.range};if(j(f,ce),"spot"===a){var p=r;f.spot={innerConeAngle:p.innerAngle/2,outerConeAngle:p.angle/2},j(f.spot,le)}s._lights||(s._lights={lights:[]}),s._lights.lights.push(f);var d={light:s._lights.lights.length-1},_=r.parent;if(_&&q(r,_)){var m=n.get(_);if(m){var g=s._exporter._nodes[m];return W(t,g),g.extensions||(g.extensions={}),g.extensions[ue]=d,void o(null)}}t.extensions||(t.extensions={}),t.extensions[ue]=d,o(t)}else o(t)}))];case 1:return[2,o.sent()]}}))}))},e}();re.RegisterExtension(ue,(function(e){return new he(e)}));var pe="KHR_materials_anisotropy",de=function(){function e(e){this.name=pe,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof h.PBRBaseMaterial&&r.anisotropy.isEnabled&&!r.anisotropy.legacy?(r.anisotropy.texture&&n.push(r.anisotropy.texture),n):[]},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){if(r instanceof h.PBRBaseMaterial){if(!r.anisotropy.isEnabled||r.anisotropy.legacy)return void e(t);n._wasUsed=!0,t.extensions=t.extensions||{};var i=n._exporter._materialExporter.getTextureInfo(r.anisotropy.texture),s={anisotropyStrength:r.anisotropy.intensity,anisotropyRotation:r.anisotropy.angle,anisotropyTexture:null!=i?i:void 0};null!==s.anisotropyTexture&&n._exporter._materialNeedsUVsSet.add(r),t.extensions[pe]=s}e(t)}))},e}();re.RegisterExtension(pe,(function(e){return new de(e)}));var _e="KHR_materials_clearcoat",me=function(){function e(e){this.name=_e,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof h.PBRBaseMaterial&&r.clearCoat.isEnabled?(r.clearCoat.texture&&n.push(r.clearCoat.texture),!r.clearCoat.useRoughnessFromMainTexture&&r.clearCoat.textureRoughness&&n.push(r.clearCoat.textureRoughness),r.clearCoat.bumpTexture&&n.push(r.clearCoat.bumpTexture),n):[]},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){if(r instanceof h.PBRBaseMaterial){if(!r.clearCoat.isEnabled)return void e(t);n._wasUsed=!0,t.extensions=t.extensions||{};var i,s=n._exporter._materialExporter.getTextureInfo(r.clearCoat.texture);i=r.clearCoat.useRoughnessFromMainTexture?n._exporter._materialExporter.getTextureInfo(r.clearCoat.texture):n._exporter._materialExporter.getTextureInfo(r.clearCoat.textureRoughness),r.clearCoat.isTintEnabled&&h.Tools.Warn("Clear Color tint is not supported for glTF export. Ignoring for: ".concat(r.name)),r.clearCoat.remapF0OnInterfaceChange&&h.Tools.Warn("Clear Color F0 remapping is not supported for glTF export. Ignoring for: ".concat(r.name));var o=n._exporter._materialExporter.getTextureInfo(r.clearCoat.bumpTexture),a={clearcoatFactor:r.clearCoat.intensity,clearcoatTexture:null!=s?s:void 0,clearcoatRoughnessFactor:r.clearCoat.roughness,clearcoatRoughnessTexture:null!=i?i:void 0,clearcoatNormalTexture:null!=o?o:void 0};null===a.clearcoatTexture&&null===a.clearcoatRoughnessTexture&&null===a.clearcoatRoughnessTexture||n._exporter._materialNeedsUVsSet.add(r),t.extensions[_e]=a}e(t)}))},e}();re.RegisterExtension(_e,(function(e){return new me(e)}));var ge="KHR_materials_diffuse_transmission";function xe(e,t){var r=t.subSurface,n=null;return r.translucencyIntensityTexture?n=r.translucencyIntensityTexture:r.thicknessTexture&&r.useMaskFromThicknessTexture&&(n=r.thicknessTexture),n&&!r.useGltfStyleTextures?(h.Logger.Warn("".concat(e,": Translucency intensity texture is not supported when useGltfStyleTextures = false. Ignoring for: ").concat(t.name),1),null):n}var ye=function(){function e(e){this.name=ge,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];if(r instanceof h.PBRMaterial&&this._isExtensionEnabled(r)){var i=xe(e,r);return i&&n.push(i),r.subSurface.translucencyColorTexture&&n.push(r.subSurface.translucencyColorTexture),n}return n},e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return!!t.isTranslucencyEnabled&&!e.unlit&&!t.useAlbedoToTintTranslucency&&t.useGltfStyleTextures&&1===t.volumeIndexOfRefraction&&0===t.minimumThickness&&0===t.maximumThickness},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(i){var s,o;if(r instanceof h.PBRMaterial&&n._isExtensionEnabled(r)){n._wasUsed=!0;var a=r.subSurface,u=xe(e,r),c=0==a.translucencyIntensity?void 0:a.translucencyIntensity,l=null!==(s=n._exporter._materialExporter.getTextureInfo(u))&&void 0!==s?s:void 0,f=!a.translucencyColor||a.translucencyColor.equalsFloats(1,1,1)?void 0:a.translucencyColor.asArray(),p=null!==(o=n._exporter._materialExporter.getTextureInfo(a.translucencyColorTexture))&&void 0!==o?o:void 0,d={diffuseTransmissionFactor:c,diffuseTransmissionTexture:l,diffuseTransmissionColorFactor:f,diffuseTransmissionColorTexture:p};(l||p)&&n._exporter._materialNeedsUVsSet.add(r),t.extensions=t.extensions||{},t.extensions[ge]=d}i(t)}))},e}();re.RegisterExtension(ge,(function(e){return new ye(e)}));var ve="KHR_materials_dispersion",Te=function(){function e(){this.name=ve,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return!(!t.isRefractionEnabled&&!t.isDispersionEnabled)},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){if(r instanceof h.PBRMaterial&&n._isExtensionEnabled(r)){n._wasUsed=!0;var i={dispersion:r.subSurface.dispersion};t.extensions=t.extensions||{},t.extensions[ve]=i}e(t)}))},e}();re.RegisterExtension(ve,(function(){return new Te}));var be="KHR_materials_emissive_strength",we=function(){function e(){this.name=be,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAsync=function(e,t,r){return _(this,void 0,void 0,(function(){var e=this;return m(this,(function(n){switch(n.label){case 0:return[4,new Promise((function(n){if(!(r instanceof h.PBRMaterial))return n(t);var i=r.emissiveColor.asArray(),s=Math.max.apply(Math,i);if(s>1){e._wasUsed=!0,t.extensions||(t.extensions={});var o={emissiveStrength:s},a=r.emissiveColor.scale(1/o.emissiveStrength);t.emissiveFactor=a.asArray(),t.extensions[be]=o}return n(t)}))];case 1:return[2,n.sent()]}}))}))},e}();re.RegisterExtension(be,(function(e){return new we}));var Ae="KHR_materials_ior",Ee=function(){function e(){this.name=Ae,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype._isExtensionEnabled=function(e){return!e.unlit&&null!=e.indexOfRefraction&&1.5!=e.indexOfRefraction},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){if(r instanceof h.PBRMaterial&&n._isExtensionEnabled(r)){n._wasUsed=!0;var i={ior:r.indexOfRefraction};t.extensions=t.extensions||{},t.extensions[Ae]=i}e(t)}))},e}();re.RegisterExtension(Ae,(function(e){return new Ee}));var Me="KHR_materials_iridescence",Re=function(){function e(e){this.name=Me,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof h.PBRBaseMaterial&&r.iridescence.isEnabled?(r.iridescence.texture&&n.push(r.iridescence.texture),r.iridescence.thicknessTexture&&r.iridescence.thicknessTexture!==r.iridescence.texture&&n.push(r.iridescence.thicknessTexture),n):[]},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){if(r instanceof h.PBRBaseMaterial){if(!r.iridescence.isEnabled)return void e(t);n._wasUsed=!0,t.extensions=t.extensions||{};var i=n._exporter._materialExporter.getTextureInfo(r.iridescence.texture),s=n._exporter._materialExporter.getTextureInfo(r.iridescence.thicknessTexture),o={iridescenceFactor:r.iridescence.intensity,iridescenceIor:r.iridescence.indexOfRefraction,iridescenceThicknessMinimum:r.iridescence.minimumThickness,iridescenceThicknessMaximum:r.iridescence.maximumThickness,iridescenceTexture:null!=i?i:void 0,iridescenceThicknessTexture:null!=s?s:void 0};null===o.iridescenceTexture&&null===o.iridescenceThicknessTexture||n._exporter._materialNeedsUVsSet.add(r),t.extensions[Me]=o}e(t)}))},e}();re.RegisterExtension(Me,(function(e){return new Re(e)}));var Ve="KHR_materials_sheen",Ce=function(){function e(e){this.name=Ve,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){return r instanceof h.PBRMaterial&&r.sheen.isEnabled&&r.sheen.texture?[r.sheen.texture]:[]},e.prototype.postExportMaterialAsync=function(e,t,r){return _(this,void 0,void 0,(function(){var e=this;return m(this,(function(n){switch(n.label){case 0:return[4,new Promise((function(n){var i,s,o,a;if(r instanceof h.PBRMaterial){if(!r.sheen.isEnabled)return void n(t);e._wasUsed=!0,null==t.extensions&&(t.extensions={});var u={sheenColorFactor:r.sheen.color.asArray(),sheenRoughnessFactor:null!==(i=r.sheen.roughness)&&void 0!==i?i:0};null===u.sheenColorTexture&&null===u.sheenRoughnessTexture||e._exporter._materialNeedsUVsSet.add(r),r.sheen.texture&&(u.sheenColorTexture=null!==(s=e._exporter._materialExporter.getTextureInfo(r.sheen.texture))&&void 0!==s?s:void 0),r.sheen.textureRoughness&&!r.sheen.useRoughnessFromMainTexture?u.sheenRoughnessTexture=null!==(o=e._exporter._materialExporter.getTextureInfo(r.sheen.textureRoughness))&&void 0!==o?o:void 0:r.sheen.texture&&r.sheen.useRoughnessFromMainTexture&&(u.sheenRoughnessTexture=null!==(a=e._exporter._materialExporter.getTextureInfo(r.sheen.texture))&&void 0!==a?a:void 0),t.extensions[Ve]=u}n(t)}))];case 1:return[2,n.sent()]}}))}))},e}();re.RegisterExtension(Ve,(function(e){return new Ce(e)}));var Se="KHR_materials_specular",Ie=function(){function e(e){this.name=Se,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof h.PBRMaterial&&this._isExtensionEnabled(r)?(r.metallicReflectanceTexture&&n.push(r.metallicReflectanceTexture),r.reflectanceTexture&&n.push(r.reflectanceTexture),n):n},e.prototype._isExtensionEnabled=function(e){return!e.unlit&&(null!=e.metallicF0Factor&&1!=e.metallicF0Factor||null!=e.metallicReflectanceColor&&!e.metallicReflectanceColor.equalsFloats(1,1,1)||this._hasTexturesExtension(e))},e.prototype._hasTexturesExtension=function(e){return null!=e.metallicReflectanceTexture||null!=e.reflectanceTexture},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){var i,s;if(r instanceof h.PBRMaterial&&n._isExtensionEnabled(r)){n._wasUsed=!0,t.extensions=t.extensions||{};var o=null!==(i=n._exporter._materialExporter.getTextureInfo(r.metallicReflectanceTexture))&&void 0!==i?i:void 0,a=null!==(s=n._exporter._materialExporter.getTextureInfo(r.reflectanceTexture))&&void 0!==s?s:void 0,u={specularFactor:1==r.metallicF0Factor?void 0:r.metallicF0Factor,specularTexture:o,specularColorFactor:r.metallicReflectanceColor.equalsFloats(1,1,1)?void 0:r.metallicReflectanceColor.asArray(),specularColorTexture:a};n._hasTexturesExtension(r)&&n._exporter._materialNeedsUVsSet.add(r),t.extensions[Se]=u}e(t)}))},e}();re.RegisterExtension(Se,(function(e){return new Ie(e)}));var Be="KHR_materials_transmission",Fe=function(){function e(e){this.name=Be,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof h.PBRMaterial&&this._isExtensionEnabled(r)?(r.subSurface.thicknessTexture&&n.push(r.subSurface.thicknessTexture),n):n},e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return t.isRefractionEnabled&&null!=t.refractionIntensity&&0!=t.refractionIntensity||this._hasTexturesExtension(e)},e.prototype._hasTexturesExtension=function(e){return null!=e.subSurface.refractionIntensityTexture},e.prototype.postExportMaterialAsync=function(e,t,r){return _(this,void 0,void 0,(function(){var n,i,s,o;return m(this,(function(a){switch(a.label){case 0:return r instanceof h.PBRMaterial&&this._isExtensionEnabled(r)?(this._wasUsed=!0,n=r.subSurface,i=0===n.refractionIntensity?void 0:n.refractionIntensity,s={transmissionFactor:i},this._hasTexturesExtension(r)&&this._exporter._materialNeedsUVsSet.add(r),n.refractionIntensityTexture?n.useGltfStyleTextures?[4,this._exporter._materialExporter.exportTextureAsync(n.refractionIntensityTexture)]:[3,2]:[3,3]):[3,4];case 1:return(o=a.sent())&&(s.transmissionTexture=o),[3,3];case 2:h.Logger.Warn("".concat(e,": Exporting a subsurface refraction intensity texture without `useGltfStyleTextures` is not supported")),a.label=3;case 3:t.extensions||(t.extensions={}),t.extensions[Be]=s,a.label=4;case 4:return[2,t]}}))}))},e}();re.RegisterExtension(Be,(function(e){return new Fe(e)}));var Ne="KHR_materials_unlit",Ue=function(){function e(){this.name=Ne,this.enabled=!0,this.required=!1,this._wasUsed=!1}return Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){var i=!1;r instanceof h.PBRMaterial?i=r.unlit:r instanceof h.StandardMaterial&&(i=r.disableLighting),i&&(n._wasUsed=!0,null==t.extensions&&(t.extensions={}),t.extensions[Ne]={}),e(t)}))},e}();re.RegisterExtension(Ne,(function(){return new Ue}));var Oe="KHR_materials_volume",Pe=function(){function e(e){this.name=Oe,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof h.PBRMaterial&&this._isExtensionEnabled(r)?(r.subSurface.thicknessTexture&&n.push(r.subSurface.thicknessTexture),n):n},e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return!(!t.isRefractionEnabled&&!t.isTranslucencyEnabled)&&(null!=t.maximumThickness&&0!=t.maximumThickness||null!=t.tintColorAtDistance&&t.tintColorAtDistance!=Number.POSITIVE_INFINITY||null!=t.tintColor&&t.tintColor!=h.Color3.White()||this._hasTexturesExtension(e))},e.prototype._hasTexturesExtension=function(e){return null!=e.subSurface.thicknessTexture},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){var i;if(r instanceof h.PBRMaterial&&n._isExtensionEnabled(r)){n._wasUsed=!0;var s=r.subSurface,o={thicknessFactor:0==s.maximumThickness?void 0:s.maximumThickness,thicknessTexture:null!==(i=n._exporter._materialExporter.getTextureInfo(s.thicknessTexture))&&void 0!==i?i:void 0,attenuationDistance:s.tintColorAtDistance==Number.POSITIVE_INFINITY?void 0:s.tintColorAtDistance,attenuationColor:s.tintColor.equalsFloats(1,1,1)?void 0:s.tintColor.asArray()};n._hasTexturesExtension(r)&&n._exporter._materialNeedsUVsSet.add(r),t.extensions=t.extensions||{},t.extensions[Oe]=o}e(t)}))},e}();re.RegisterExtension(Oe,(function(e){return new Pe(e)}));var Le="EXT_materials_diffuse_roughness",Ke=function(){function e(e){this.name=Le,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof h.PBRBaseMaterial&&r._baseDiffuseRoughness?(r._baseDiffuseRoughnessTexture&&n.push(r._baseDiffuseRoughnessTexture),n):[]},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){if(r instanceof h.PBRBaseMaterial){if(!r._baseDiffuseRoughness)return void e(t);n._wasUsed=!0,t.extensions=t.extensions||{};var i=n._exporter._materialExporter.getTextureInfo(r._baseDiffuseRoughnessTexture),s={diffuseRoughnessFactor:r._baseDiffuseRoughness,diffuseRoughnessTexture:null!=i?i:void 0};null!==s.diffuseRoughnessTexture&&n._exporter._materialNeedsUVsSet.add(r),t.extensions[Le]=s}e(t)}))},e}();re.RegisterExtension(Le,(function(e){return new Ke(e)}));var ke="KHR_texture_transform",De=function(){function e(){this.name=ke,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportTexture=function(e,t,r){if(r.getScene()||h.Tools.Warn("".concat(e,': "scene" is not defined for Babylon texture ').concat(r.name,"!")),0===r.uAng&&0===r.vAng||(h.Tools.Warn("".concat(e,": Texture ").concat(r.name," with rotation in the u or v axis is not supported in glTF.")),0===r.uRotationCenter&&0===r.vRotationCenter)){var n={},i=!1;if(0===r.uOffset&&0===r.vOffset||(n.offset=[r.uOffset,r.vOffset],i=!0),1===r.uScale&&1===r.vScale||(n.scale=[r.uScale,r.vScale],i=!0),0!==r.wAng){if(0!==r.uRotationCenter||0!==r.vRotationCenter){if(r.homogeneousRotationInUVTransform&&r.uScale!==r.vScale)return void h.Tools.Warn("".concat(e,": Texture ").concat(r.name," with homogenousRotationInUVTransform, non-uniform scaling, and non-zero rotation cannot be exported with ").concat(ke,"."));h.Tools.Warn("".concat(e,": Texture ").concat(r.name," with non-origin rotation center will be exported using an adjusted offset with ").concat(ke,".")),n.offset=function(e){var t=e.uOffset,r=e.vOffset,n=e.uRotationCenter,i=e.vRotationCenter,s=e.uScale,o=e.vScale,a=e.wAng,u=Math.cos(a),c=Math.sin(a),l=n*s,f=i*o;return[t+(l*(1-u)+f*c),r+(f*(1-u)-l*c)]}(r)}n.rotation=-r.wAng,i=!0}0!==r.coordinatesIndex&&(n.texCoord=r.coordinatesIndex,i=!0),i&&(this._wasUsed=!0,t.extensions||(t.extensions={}),t.extensions[ke]=n)}},e}();re.RegisterExtension(ke,(function(){return new De}));var Ge="KHR_texture_basisu",He=function(){function e(e){this.name=Ge,this.enabled=!0,this.required=!0,this._wasUsed=!1,this._exporter=e}return Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){},e.prototype.postExportTexture=function(e,t){var r=this._exporter._textures[t.index],n=r.source;if(void 0!==n){var i=this._exporter._images[n];"image/ktx2"===(i.mimeType||(0,h.GetMimeType)(i.uri))&&(r.source=void 0,r.extensions||(r.extensions={}),r.extensions[Ge]={source:n},this._wasUsed=!0)}},e}();re.RegisterExtension(Ge,(function(e){return new He(e)}));var We="EXT_texture_webp",qe=function(){function e(e){this.name=We,this.enabled=!0,this.required=!0,this._wasUsed=!1,this._exporter=e}return Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){},e.prototype.postExportTexture=function(e,t){var r=this._exporter._textures[t.index],n=r.source;if(void 0!==n){var i=this._exporter._images[n];"image/webp"===(i.mimeType||(0,h.GetMimeType)(i.uri))&&(r.source=void 0,r.extensions||(r.extensions={}),r.extensions[We]={source:n},this._wasUsed=!0)}},e}();re.RegisterExtension(We,(function(e){return new qe(e)}));var je="EXT_texture_avif",ze=function(){function e(e){this.name=je,this.enabled=!0,this.required=!0,this._wasUsed=!1,this._exporter=e}return Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){},e.prototype.postExportTexture=function(e,t){var r=this._exporter._textures[t.index],n=r.source;if(void 0!==n){var i=this._exporter._images[n];"image/avif"===(i.mimeType||(0,h.GetMimeType)(i.uri))&&(r.source=void 0,r.extensions||(r.extensions={}),r.extensions[je]={source:n},this._wasUsed=!0)}},e}();re.RegisterExtension(je,(function(e){return new ze(e)}));var Qe=void 0!==n.g?n.g:"undefined"!=typeof window?window:void 0;if(void 0!==Qe){Qe.BABYLON=Qe.BABYLON||{};var Xe=Qe.BABYLON;Xe.GLTF2=Xe.GLTF2||{},Xe.GLTF2.Exporter=Xe.GLTF2.Exporter||{},Xe.GLTF2.Exporter.Extensions=Xe.GLTF2.Exporter.Extensions||{};var Ye=[];for(var Ze in s)Xe[Ze]=s[Ze],Ye.push(Ze);for(var Ze in o)Xe[Ze]=o[Ze],Ye.push(Ze);for(var Ze in a)Xe[Ze]=a[Ze],Ye.push(Ze);for(var Ze in u)Xe.GLTF2.Exporter.Extensions[Ze]=u[Ze],Ye.push(Ze);for(var Ze in c)Ye.indexOf(Ze)>-1||(Xe.GLTF2.Exporter[Ze]=c[Ze])}const Je=l;return i.default})()));
//# sourceMappingURL=babylon.glTF2Serializer.min.js.map